<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css">


  <meta name="keywords" content="Hexo, NexT">








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0">






<meta name="description" content="少敲代码，多陪家人">
<meta property="og:type" content="website">
<meta property="og:title" content="seven-cm.blog">
<meta property="og:url" content="http://seven-cm.github.io/page/2/index.html">
<meta property="og:site_name" content="seven-cm.blog">
<meta property="og:description" content="少敲代码，多陪家人">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="seven-cm.blog">
<meta name="twitter:description" content="少敲代码，多陪家人">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://seven-cm.github.io/page/2/">





  <title> seven-cm.blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?fea19912a68edcd8dd8884f7fc44c677";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">seven-cm.blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://seven-cm.github.io/2019/05/01/指定git的端口以及密钥/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="seven-cm">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="seven-cm.blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2019/05/01/指定git的端口以及密钥/" itemprop="url">
                  指定git的端口以及密钥
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-01T22:59:32+08:00">
                2019-05-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>为了提高服务器的安全，一般ssh 22端口都会更换为其他端口；<br>若在不是ssh为22端口的服务器中搭建git，需要指定git的端口才能正常使用。</p>
<h2 id="指定git端口"><a href="#指定git端口" class="headerlink" title="指定git端口"></a>指定git端口</h2><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">ssh:</span>//git<span class="subst">@192</span><span class="number">.168</span><span class="number">.1</span><span class="number">.10</span>:<span class="number">8888</span>/xxx.git</span><br></pre></td></tr></table></figure>
<h2 id="指定git使用的密钥"><a href="#指定git使用的密钥" class="headerlink" title="指定git使用的密钥"></a>指定git使用的密钥</h2><h3 id="在-ssh目录下增加config"><a href="#在-ssh目录下增加config" class="headerlink" title="在.ssh目录下增加config"></a>在.ssh目录下增加config</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cd ~</span><br><span class="line">cd .ssh</span><br><span class="line">touch config</span><br><span class="line">vi config</span><br><span class="line"><span class="comment">#config内容如下</span></span><br><span class="line">Host githost</span><br><span class="line">    HostName 192.168.1.10</span><br><span class="line">   <span class="built_in"> Port </span>8888</span><br><span class="line">   <span class="built_in"> User </span>git</span><br><span class="line">    IdentityFile /Users/your/.ssh/your_id_rsa</span><br></pre></td></tr></table></figure>
<blockquote>
<p>若仓库已经clone下来，需执行以下操作</p>
</blockquote>
<h3 id="修改-git下的config"><a href="#修改-git下的config" class="headerlink" title="修改.git下的config"></a>修改.git下的config</h3><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#将url修改即可</span></span><br><span class="line"><span class="meta"># url = ssh://git@192.168.1.10:8888/xxx.git</span></span><br><span class="line">url = ssh:<span class="comment">//git@githost/xxx.git</span></span><br></pre></td></tr></table></figure>
<h1 id="update-2019-05-07"><a href="#update-2019-05-07" class="headerlink" title="update 2019-05-07"></a>update 2019-05-07</h1><p>该方式在Xcode中会失效～</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://seven-cm.github.io/2019/05/01/CentOS-搭建-gitolite/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="seven-cm">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="seven-cm.blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2019/05/01/CentOS-搭建-gitolite/" itemprop="url">
                  CentOS 搭建 gitolite
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-01T22:58:30+08:00">
                2019-05-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最近准备把svn更换为git，为了方便管理用户权限，准备使用gitolite。</p>
<h2 id="安装git"><a href="#安装git" class="headerlink" title="安装git"></a>安装git</h2><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y <span class="keyword">install</span> git</span><br></pre></td></tr></table></figure>
<h2 id="安装gitolite依赖"><a href="#安装gitolite依赖" class="headerlink" title="安装gitolite依赖"></a>安装gitolite依赖</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y <span class="keyword">install</span> perl</span><br><span class="line">yum -y <span class="keyword">install</span> perl-<span class="keyword">Data</span>-Dumper.x86_64</span><br></pre></td></tr></table></figure>
<h2 id="添加git用户"><a href="#添加git用户" class="headerlink" title="添加git用户"></a>添加git用户</h2><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">useradd git</span></span><br></pre></td></tr></table></figure>
<h2 id="安装gitolite"><a href="#安装gitolite" class="headerlink" title="安装gitolite"></a>安装gitolite</h2><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">su</span> git</span><br><span class="line"><span class="keyword">cd</span> ~</span><br><span class="line">git clone https:<span class="comment">//github.com/sitaramc/gitolite</span></span><br><span class="line"><span class="keyword">mkdir</span> bin</span><br><span class="line">./gitolite/install -to <span class="variable">$HOME</span>/bin</span><br></pre></td></tr></table></figure>
<h2 id="下面的步骤可在客户端做或直接在git用户下操作也可以"><a href="#下面的步骤可在客户端做或直接在git用户下操作也可以" class="headerlink" title="下面的步骤可在客户端做或直接在git用户下操作也可以"></a>下面的步骤可在客户端做或直接在git用户下操作也可以</h2><blockquote>
<p>区别是，如果你想在客户端管理（添加用户，仓库等信息）就在客户端增加；若仅仅在服务端管理，就在服务端操作即可<br><figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#生成rsa密钥</span></span><br><span class="line">ssh-keygen -t rsa</span><br><span class="line">mv .ssh/id_rsa.pub <span class="literal">admin</span>.pub</span><br><span class="line"><span class="variable">$HOME</span>/bin/gitolite setup -pk .ssh/<span class="literal">admin</span>.pub</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="clone配置仓库"><a href="#clone配置仓库" class="headerlink" title="clone配置仓库"></a>clone配置仓库</h2><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone <span class="symbol">git@</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:gitolite-admin</span><br></pre></td></tr></table></figure>
<blockquote>
<p>clone后即可在此仓库中配置git的用户密钥、仓库、权限</p>
</blockquote>
<h2 id="配置说明"><a href="#配置说明" class="headerlink" title="配置说明"></a>配置说明</h2><p>相关配置，可参考网站：<br><a href="https://git-scm.com/book/zh/v1/%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E7%9A%84-Git-Gitolite" target="_blank" rel="noopener">https://git-scm.com/book/zh/v1/%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E7%9A%84-Git-Gitolite</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://seven-cm.github.io/2019/04/24/VisualVM远程监控阿里云tomcat/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="seven-cm">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="seven-cm.blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2019/04/24/VisualVM远程监控阿里云tomcat/" itemprop="url">
                  VisualVM远程监控阿里云tomcat
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-24T23:03:59+08:00">
                2019-04-24
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最近阿里云上的cpu占用率比较高，想了解是什么原因造成；故打算使用VisualVM工具来监控一下。</p>
<h2 id="下载地址"><a href="#下载地址" class="headerlink" title="下载地址"></a>下载地址</h2><p>搜索一下，就能找到相关的网站 <a href="https://visualvm.github.io/" target="_blank" rel="noopener">https://visualvm.github.io/</a><br>到下载页面：<a href="https://visualvm.github.io/download.html" target="_blank" rel="noopener">https://visualvm.github.io/download.html</a> 即可下载</p>
<h2 id="增加tomcat的启动参数"><a href="#增加tomcat的启动参数" class="headerlink" title="增加tomcat的启动参数"></a>增加tomcat的启动参数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">JMX_OPTS="\</span><br><span class="line">  -Djava.rmi.server.hostname=172.17.111.20\</span><br><span class="line">  -Dcom.sun.management.jmxremote\</span><br><span class="line">  -Dcom.sun.management.jmxremote.port=8088\</span><br><span class="line">  -Dcom.sun.management.jmxremote.ssl=false\</span><br><span class="line">  -Dcom.sun.management.jmxremote.authenticate=true\</span><br><span class="line">  -Dcom.sun.management.jmxremote.password.file=../conf/jmx/jmxremote.password\</span><br><span class="line">  -Dcom.sun.management.jmxremote.access.file=./conf/jmx/jmxremote.access\</span><br><span class="line">"</span><br><span class="line"><span class="meta">#</span><span class="bash">增加到tomcat启动参数中去</span></span><br><span class="line">CATALINA_OPTS="$&#123;CATALINA_OPTS&#125; $&#123;JMX_OPTS&#125; -Xss2m"</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">----------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash">jmxremote.access 文件内容如下 配置账户权限</span></span><br><span class="line">monitorRole readonly</span><br><span class="line">controlRole readwrite</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">jmxremote.password 文件内容如下 配置账户密码</span></span><br><span class="line">monitorRole read123456</span><br><span class="line">controlRole rw123456</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 最后需将文件权限修改为400</span></span><br><span class="line"><span class="meta">#</span><span class="bash">----------------------------------------</span></span><br></pre></td></tr></table></figure>
<h2 id="问题来了"><a href="#问题来了" class="headerlink" title="问题来了"></a>问题来了</h2><p>然而就算安全组开放了端口8088，VisualVM还是不能链接上去。</p>
<h2 id="解决方式"><a href="#解决方式" class="headerlink" title="解决方式"></a>解决方式</h2><p>搜索了一下，才知道原来在启动 jmxremote 的时候除了指定端口，还会随机开启其他两个端口；我们使用<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">列出正在使用该端口的信息</span></span><br><span class="line">netstat -lnp|grep 8088</span><br><span class="line"><span class="meta">#</span><span class="bash">查看该pid所占用的端口</span></span><br><span class="line">netstat -lnp|grep pid </span><br><span class="line"></span><br><span class="line">tcp        0      0 0.0.0.0:36256               0.0.0.0:*                   LISTEN      4825/jsvc.exec      </span><br><span class="line">tcp        0      0 0.0.0.0:8088                0.0.0.0:*                   LISTEN      4825/jsvc.exec      </span><br><span class="line">tcp        0      0 0.0.0.0:39030               0.0.0.0:*                   LISTEN      4825/jsvc.exec  </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">看来还需要开放 36256 39030 这两个端口</span></span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://seven-cm.github.io/2019/03/19/swagger-ui-排序问题-接上篇/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="seven-cm">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="seven-cm.blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2019/03/19/swagger-ui-排序问题-接上篇/" itemprop="url">
                  swagger ui 排序问题-接上篇
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-19T22:56:44+08:00">
                2019-03-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>我们已经将后端所需的Swagger已经按position排序，但是通过swagger-ui.html看的结果还是按path排序，那么肯定是在前端展示的时候，又做了排序。唯有修改swagger-ui源码来解决该问题～</p>
<h2 id="下载swagger-ui前端源码"><a href="#下载swagger-ui前端源码" class="headerlink" title="下载swagger-ui前端源码"></a>下载swagger-ui前端源码</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>我们查看上述jar包的MANIFEST.MF文件的信息<br><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Manifest-Version: <span class="number">1.0</span></span><br><span class="line">Implementation-Title: springfox-swagger-ui</span><br><span class="line">Built-With: gradle<span class="number">-4.6</span>, groovy<span class="number">-2.4</span><span class="number">.12</span></span><br><span class="line">Implementation-Version: <span class="number">2.9</span><span class="number">.2</span></span><br><span class="line">SwaggerUi-Version: <span class="number">3.17</span><span class="number">.1</span></span><br><span class="line">Built-By: d_krishnan</span><br><span class="line">Build-Time: <span class="number">2018</span><span class="number">-06</span><span class="number">-23</span>T17:<span class="number">02</span>:<span class="number">09</span><span class="number">-0500</span></span><br><span class="line">Created-By: <span class="number">1.8</span><span class="number">.0</span>_151 (Oracle Corporation)</span><br><span class="line">Built-On: ISDV161716L.local/<span class="number">192.168</span><span class="number">.1</span><span class="number">.163</span></span><br></pre></td></tr></table></figure></p>
<p>由此可见，此jar包中的swagger-ui是根据3.17.1版本构建的。我们来看看swagger-ui在github上的信息<br><a href="https://github.com/swagger-api/swagger-ui" target="_blank" rel="noopener">https://github.com/swagger-api/swagger-ui</a><br>查看tag标签，找到3.17.1版本 <a href="https://github.com/swagger-api/swagger-ui/tree/v3.17.1" target="_blank" rel="noopener">https://github.com/swagger-api/swagger-ui/tree/v3.17.1</a><br>下载下来。</p>
<h2 id="调试源码"><a href="#调试源码" class="headerlink" title="调试源码"></a>调试源码</h2><blockquote>
<p>源码的调试，涉及node环境的安装，此处不再叙述。只是简单展示相关的调试步骤。</p>
</blockquote>
<h3 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h3><p>使用vscode 打开文件夹 swagger-ui-3.17.1；在终端输入<br><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm <span class="keyword">install</span></span><br></pre></td></tr></table></figure></p>
<h3 id="配置获取swagger信息的url"><a href="#配置获取swagger信息的url" class="headerlink" title="配置获取swagger信息的url"></a>配置获取swagger信息的url</h3><p>我们可以在dev-helpers文件夹下的index.html配置<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// Build a system</span><br><span class="line">      const ui = SwaggerUIBundle(&#123;</span><br><span class="line">        url: "http://localhost:8080/cms/v2/api-docs",</span><br><span class="line">        dom_id: '#swagger-ui',</span><br><span class="line">        presets: [</span><br><span class="line">          SwaggerUIBundle.presets.apis,</span><br><span class="line">          SwaggerUIStandalonePreset</span><br><span class="line">        ],</span><br><span class="line">        plugins: [</span><br><span class="line">          SwaggerUIBundle.plugins.DownloadUrl</span><br><span class="line">        ],</span><br><span class="line">        layout: "StandaloneLayout"</span><br><span class="line">      &#125;)</span><br></pre></td></tr></table></figure></p>
<p>在url中配置获取swagger的url即可。</p>
<h3 id="出现Failed-to-load-API-definition"><a href="#出现Failed-to-load-API-definition" class="headerlink" title="出现Failed to load API definition."></a>出现Failed to load API definition.</h3><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Errors</span><br><span class="line">Hide</span><br><span class="line">Fetch errorFailed <span class="built_in">to</span> fetch <span class="keyword">http</span>://localhost:<span class="number">8080</span>/cms/v2/api-docs</span><br><span class="line">Fetch errorPossible cross-origin (CORS) issue? The <span class="built_in">URL</span> origin (<span class="keyword">http</span>://localhost:<span class="number">8080</span>) does <span class="keyword">not</span> match <span class="keyword">the</span> page (<span class="keyword">http</span>://localhost:<span class="number">3200</span>). Check <span class="keyword">the</span> server returns <span class="keyword">the</span> correct <span class="string">'Access-Control-Allow-*'</span> headers.</span><br></pre></td></tr></table></figure>
<h3 id="看来是跨越的问题，我们增加其他方法来处理"><a href="#看来是跨越的问题，我们增加其他方法来处理" class="headerlink" title="看来是跨越的问题，我们增加其他方法来处理"></a>看来是跨越的问题，我们增加其他方法来处理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sevencm.cms.swagger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Primary;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.env.Environment;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.CrossOrigin;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMethod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.annotations.ApiIgnore;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.spring.web.DocumentationCache;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.spring.web.json.Json;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.spring.web.json.JsonSerializer;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.swagger2.mappers.ServiceModelToSwagger2Mapper;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.swagger2.web.Swagger2Controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.util.MimeTypeUtils.APPLICATION_JSON_VALUE;</span><br><span class="line"></span><br><span class="line"><span class="meta">@CrossOrigin</span>(origins = &#123;<span class="string">"http://localhost:3200"</span>, <span class="string">"null"</span>&#125;)</span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@ApiIgnore</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Swagger2ControllerCORS</span> <span class="keyword">extends</span> <span class="title">Swagger2Controller</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_URL = <span class="string">"/v2/api-docs/CORS"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Swagger2ControllerCORS</span><span class="params">(Environment environment,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  DocumentationCache documentationCache,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  ServiceModelToSwagger2Mapper mapper,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  JsonSerializer jsonSerializer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(environment, documentationCache, mapper, jsonSerializer);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(</span><br><span class="line">            value = DEFAULT_URL,</span><br><span class="line">            method = RequestMethod.GET,</span><br><span class="line">            produces = &#123; APPLICATION_JSON_VALUE &#125;)</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;Json&gt; <span class="title">getDocumentation</span><span class="params">(String swaggerGroup, HttpServletRequest servletRequest)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.getDocumentation(swaggerGroup, servletRequest);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以在<br>swagger-ui的前端源代码中，修改以下代码，则可以修改前端又自动排序的问题<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件：swagger-ui-3.17.1/src/core/plugins/spec/selectors.js </span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> taggedOperations = <span class="function">(<span class="params">state</span>) =&gt;</span> <span class="function">(<span class="params">&#123; getConfigs &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> &#123; tagsSorter, operationsSorter &#125; = getConfigs()</span><br><span class="line">  <span class="keyword">return</span> operationsWithTags(state)</span><br><span class="line">    <span class="comment">// .sortBy(</span></span><br><span class="line">    <span class="comment">//   (val, key) =&gt; key, // get the name of the tag to be passed to the sorter</span></span><br><span class="line">    <span class="comment">//   (tagA, tagB) =&gt; &#123;</span></span><br><span class="line">    <span class="comment">//     let sortFn = (typeof tagsSorter === "function" ? tagsSorter : sorters.tagsSorter[ tagsSorter ])</span></span><br><span class="line">    <span class="comment">//     return (!sortFn ? null : sortFn(tagA, tagB))</span></span><br><span class="line">    <span class="comment">//   &#125;</span></span><br><span class="line">    <span class="comment">// )</span></span><br><span class="line">    .map(<span class="function">(<span class="params">ops, tag</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// let sortFn = (typeof operationsSorter === "function" ? operationsSorter : sorters.operationsSorter[ operationsSorter ])</span></span><br><span class="line">      <span class="comment">// let operations = (!sortFn ? ops : ops.sort(sortFn))</span></span><br><span class="line">      <span class="keyword">let</span> operations = ops</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Map</span>(&#123; <span class="attr">tagDetails</span>: tagDetails(state, tag), <span class="attr">operations</span>: operations &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://seven-cm.github.io/2019/03/14/swagger-ui-排序问题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="seven-cm">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="seven-cm.blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2019/03/14/swagger-ui-排序问题/" itemprop="url">
                  swagger-ui 排序问题
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-14T23:17:56+08:00">
                2019-03-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最近使用了最新版本的springfox-swagger2做api接口文档；但是发现之前的position已过时，而且即使修改了springfox的java代码，排序还是按api的path排序。故，有了修改swagger-ui代码的想法。</p>
<h2 id="依赖信息"><a href="#依赖信息" class="headerlink" title="依赖信息"></a>依赖信息</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h2><p>我们启动工程后，访问swagger-ui.html能看到获取api信息的url地址:<a href="http://localhost:8080/cms/v2/api-docs" target="_blank" rel="noopener">http://localhost:8080/cms/v2/api-docs</a><br>我们使用idea搜索（ctrl+shitf+F）一下api-docs，范围选择scope会发现一个Swagger2Controller的类。打开，可见到如下代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(</span><br><span class="line">    value = DEFAULT_URL,</span><br><span class="line">    method = RequestMethod.GET,</span><br><span class="line">    produces = &#123; APPLICATION_JSON_VALUE, HAL_MEDIA_TYPE &#125;)</span><br><span class="line"><span class="meta">@PropertySourcedMapping</span>(</span><br><span class="line">    value = <span class="string">"$&#123;springfox.documentation.swagger.v2.path&#125;"</span>,</span><br><span class="line">    propertyKey = <span class="string">"springfox.documentation.swagger.v2.path"</span>)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ResponseEntity&lt;Json&gt; <span class="title">getDocumentation</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    @RequestParam(value = <span class="string">"group"</span>, required = <span class="keyword">false</span>)</span> String swaggerGroup,</span></span><br><span class="line"><span class="function">    HttpServletRequest servletRequest) </span>&#123;</span><br><span class="line"></span><br><span class="line">  String groupName = Optional.fromNullable(swaggerGroup).or(Docket.DEFAULT_GROUP_NAME);</span><br><span class="line">  Documentation documentation = documentationCache.documentationByGroup(groupName);</span><br><span class="line">  <span class="keyword">if</span> (documentation == <span class="keyword">null</span>) &#123;</span><br><span class="line">    LOGGER.warn(<span class="string">"Unable to find specification for group &#123;&#125;"</span>, groupName);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;Json&gt;(HttpStatus.NOT_FOUND);</span><br><span class="line">  &#125;</span><br><span class="line">  Swagger swagger = mapper.mapDocumentation(documentation);</span><br><span class="line">  UriComponents uriComponents = componentsFrom(servletRequest, swagger.getBasePath());</span><br><span class="line">  swagger.basePath(Strings.isNullOrEmpty(uriComponents.getPath()) ? <span class="string">"/"</span> : uriComponents.getPath());</span><br><span class="line">  <span class="keyword">if</span> (isNullOrEmpty(swagger.getHost())) &#123;</span><br><span class="line">    swagger.host(hostName(uriComponents));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;Json&gt;(jsonSerializer.toJson(swagger), HttpStatus.OK);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>从代码上看，我们可了解到，前端swagger-ui所需的api接口信息都是由Swagger对象提供。我们进入此方法</p>
<blockquote>
<p>Swagger swagger = mapper.mapDocumentation(documentation);<br>可看到此方法的实现代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Swagger <span class="title">mapDocumentation</span><span class="params">(Documentation from)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ( from == <span class="keyword">null</span> ) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Swagger swagger = <span class="keyword">new</span> Swagger();</span><br><span class="line"></span><br><span class="line">        swagger.setVendorExtensions( vendorExtensionsMapper.mapExtensions( from.getVendorExtensions() ) );</span><br><span class="line">        swagger.setSchemes( mapSchemes( from.getSchemes() ) );</span><br><span class="line">        swagger.setPaths( mapApiListings( from.getApiListings() ) );</span><br><span class="line">        swagger.setHost( from.getHost() );</span><br><span class="line">        swagger.setDefinitions( modelMapper.modelsFromApiListings( from.getApiListings() ) );</span><br><span class="line">        swagger.setSecurityDefinitions( securityMapper.toSecuritySchemeDefinitions( from.getResourceListing() ) );</span><br><span class="line">        ApiInfo info = fromResourceListingInfo( from );</span><br><span class="line">        <span class="keyword">if</span> ( info != <span class="keyword">null</span> ) &#123;</span><br><span class="line">            swagger.setInfo( mapApiInfo( info ) );</span><br><span class="line">        &#125;</span><br><span class="line">        swagger.setBasePath( from.getBasePath() );</span><br><span class="line">        swagger.setTags( tagSetToTagList( from.getTags() ) );</span><br><span class="line">        List&lt;String&gt; list2 = from.getConsumes();</span><br><span class="line">        <span class="keyword">if</span> ( list2 != <span class="keyword">null</span> ) &#123;</span><br><span class="line">            swagger.setConsumes( <span class="keyword">new</span> ArrayList&lt;String&gt;( list2 ) );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            swagger.setConsumes( <span class="keyword">null</span> );</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;String&gt; list3 = from.getProduces();</span><br><span class="line">        <span class="keyword">if</span> ( list3 != <span class="keyword">null</span> ) &#123;</span><br><span class="line">            swagger.setProduces( <span class="keyword">new</span> ArrayList&lt;String&gt;( list3 ) );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            swagger.setProduces( <span class="keyword">null</span> );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> swagger;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>从代码上的字面看，可以估计到api的请求的url等信息主要由下面的方法得到。</p>
<blockquote>
<p>swagger.setPaths( mapApiListings( from.getApiListings() ) );<br>为了查看具体的信息，我们先在此处打个断点。运行工程看看swagger paths里面的数据信息。某次执行后，debug的信息如下<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">paths = &#123;TreeMap@<span class="number">7288</span>&#125;  size = <span class="number">4</span></span><br><span class="line"> <span class="number">0</span> = &#123;TreeMap$Entry@<span class="number">7292</span>&#125; <span class="string">"/generator.cmd/a/generator"</span> -&gt; </span><br><span class="line">  <span class="type">key</span> = <span class="string">"/generator.cmd/a/generator"</span></span><br><span class="line">  value = &#123;Path@<span class="number">7297</span>&#125; </span><br><span class="line"> <span class="number">1</span> = &#123;TreeMap$Entry@<span class="number">7293</span>&#125; <span class="string">"/generator.cmd/b/generator"</span> -&gt; </span><br><span class="line">  <span class="type">key</span> = <span class="string">"/generator.cmd/b/generator"</span></span><br><span class="line">  value = &#123;Path@<span class="number">7299</span>&#125; </span><br><span class="line"> <span class="number">2</span> = &#123;TreeMap$Entry@<span class="number">7294</span>&#125; <span class="string">"/generator.cmd/c/generator"</span> -&gt; </span><br><span class="line">  <span class="type">key</span> = <span class="string">"/generator.cmd/c/generator"</span></span><br><span class="line">  value = &#123;Path@<span class="number">7301</span>&#125; </span><br><span class="line"> <span class="number">3</span> = &#123;TreeMap$Entry@<span class="number">7295</span>&#125; <span class="string">"/generator.cmd/generator"</span> -&gt; </span><br><span class="line">  <span class="type">key</span> = <span class="string">"/generator.cmd/generator"</span></span><br><span class="line">  value = &#123;Path@<span class="number">7303</span>&#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>由此可见，在生成sagger信息的时候，就已经默认使用了TreeMap方法来排序；故返回给前端的信息都是由url的path排序的。所以为实现按position排序，估计可以由此着手修改。<br>为此我们重写该方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> xxx.swagger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.common.base.Optional;</span><br><span class="line"><span class="keyword">import</span> com.google.common.collect.LinkedListMultimap;</span><br><span class="line"><span class="keyword">import</span> com.google.common.collect.Multimap;</span><br><span class="line"><span class="keyword">import</span> io.swagger.models.Operation;</span><br><span class="line"><span class="keyword">import</span> io.swagger.models.Path;</span><br><span class="line"><span class="keyword">import</span> io.swagger.models.Swagger;</span><br><span class="line"><span class="keyword">import</span> io.swagger.models.Tag;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Primary;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.service.ApiDescription;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.service.ApiListing;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.service.Documentation;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.swagger2.mappers.ServiceModelToSwagger2MapperImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.Comparator;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> springfox.documentation.builders.BuilderDefaults.nullToEmptyList;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Primary</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceModelToSwagger2MapperImplExt</span> <span class="keyword">extends</span> <span class="title">ServiceModelToSwagger2MapperImpl</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>  <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(ServiceModelToSwagger2MapperImplExt<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Swagger <span class="title">mapDocumentation</span><span class="params">(Documentation from)</span> </span>&#123;</span><br><span class="line">        Swagger swagger = <span class="keyword">super</span>.mapDocumentation(from);</span><br><span class="line">        swagger.setPaths( mapApiListings( from.getApiListings() ) );</span><br><span class="line">        <span class="comment">// 可自定义tag的排序</span></span><br><span class="line">        <span class="comment">// List&lt;Tag&gt; tags = swagger.getTags();</span></span><br><span class="line">        <span class="comment">// Collections.sort(tags, new Comparator&lt;Tag&gt;() &#123;</span></span><br><span class="line">        <span class="comment">//     @Override</span></span><br><span class="line">        <span class="comment">//     public int compare(Tag left, Tag right) &#123;</span></span><br><span class="line">        <span class="comment">//         String leftTag = left.getName().split("、")[0];</span></span><br><span class="line">        <span class="comment">//         String rightTag = right.getName().split("、")[0];</span></span><br><span class="line">        <span class="comment">//         int leftNum = 0;</span></span><br><span class="line">        <span class="comment">//         int rightNum = 0;</span></span><br><span class="line">        <span class="comment">//         try&#123;</span></span><br><span class="line">        <span class="comment">//             leftNum = Integer.parseInt(leftTag);</span></span><br><span class="line">        <span class="comment">//             rightNum = Integer.parseInt(rightTag);</span></span><br><span class="line">        <span class="comment">//         &#125;catch (Exception e)&#123;&#125;</span></span><br><span class="line">        <span class="comment">//         int position = Integer.compare(leftNum, rightNum);</span></span><br><span class="line">        <span class="comment">//         return position;</span></span><br><span class="line">        <span class="comment">//     &#125;</span></span><br><span class="line">        <span class="comment">// &#125;);</span></span><br><span class="line">        <span class="comment">// swagger.setTags(tags);</span></span><br><span class="line">        <span class="keyword">return</span> swagger;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Map&lt;String, Path&gt; <span class="title">mapApiListings</span><span class="params">(Multimap&lt;String, ApiListing&gt; apiListings)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Path&gt; paths = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">        Multimap&lt;String, ApiListing&gt; apiListingMap = LinkedListMultimap.create();</span><br><span class="line">        Iterator iter = apiListings.entries().iterator();</span><br><span class="line">        <span class="keyword">while</span>(iter.hasNext())</span><br><span class="line">        &#123;</span><br><span class="line">            Map.Entry&lt;String, ApiListing&gt; entry = (Map.Entry&lt;String, ApiListing&gt;)iter.next();</span><br><span class="line">            ApiListing apis =  entry.getValue();</span><br><span class="line">            List&lt;ApiDescription&gt; apiDesc = apis.getApis();</span><br><span class="line">            List&lt;ApiDescription&gt; newApi = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            <span class="keyword">for</span>(ApiDescription a:apiDesc)&#123;</span><br><span class="line">                newApi.add(a);</span><br><span class="line">            &#125;</span><br><span class="line">            Collections.sort(newApi, <span class="keyword">new</span> Comparator&lt;ApiDescription&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(ApiDescription left, ApiDescription right)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">int</span> leftPos = left.getOperations().size() == <span class="number">1</span> ? left.getOperations().get(<span class="number">0</span>).getPosition() : <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">int</span> rightPos = right.getOperations().size() == <span class="number">1</span> ? right.getOperations().get(<span class="number">0</span>).getPosition() : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">int</span> position = Integer.compare(leftPos, rightPos);</span><br><span class="line">                    <span class="keyword">if</span>(position == <span class="number">0</span>) &#123;</span><br><span class="line">                        position = left.getPath().compareTo(right.getPath());</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> position;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//因ApiListing的属性都是final故需要通过反射来修改值</span></span><br><span class="line">                ModifyFinalUtils.modify(apis, <span class="string">"apis"</span>, newApi);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            apiListingMap.put(entry.getKey(),apis);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (ApiListing each : apiListingMap.values()) &#123;</span><br><span class="line">            <span class="keyword">for</span> (ApiDescription api : each.getApis()) &#123;</span><br><span class="line">                paths.put(api.getPath(), mapOperations(api, Optional.fromNullable(paths.get(api.getPath()))));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> paths;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Path <span class="title">mapOperations</span><span class="params">(ApiDescription api, Optional&lt;Path&gt; existingPath)</span> </span>&#123;</span><br><span class="line">        Path path = existingPath.or(<span class="keyword">new</span> Path());</span><br><span class="line">        <span class="keyword">for</span> (springfox.documentation.service.Operation each : nullToEmptyList(api.getOperations())) &#123;</span><br><span class="line">            Operation operation = mapOperation(each);</span><br><span class="line">            path.set(each.getMethod().toString().toLowerCase(), operation);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> path;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ModifyFinalUtils</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">modify</span><span class="params">(Object object, String fieldName, Object newFieldValue)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Field field = object.getClass().getDeclaredField(fieldName);</span><br><span class="line"></span><br><span class="line">        Field modifiersField = Field.class.getDeclaredField("modifiers");</span><br><span class="line">        modifiersField.setAccessible(<span class="keyword">true</span>); <span class="comment">//Field 的 modifiers 是私有的</span></span><br><span class="line">        modifiersField.setInt(field, field.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!field.isAccessible()) &#123;</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        field.set(object, newFieldValue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行后，我们debug可以得到以下信息<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">paths = &#123;LinkedHashMap@<span class="number">7364</span>&#125;  size = <span class="number">4</span></span><br><span class="line"> <span class="number">0</span> = &#123;LinkedHashMap$Entry@<span class="number">7370</span>&#125; <span class="string">"/generator.cmd/b/generator"</span> -&gt; </span><br><span class="line">  <span class="type">key</span> = <span class="string">"/generator.cmd/b/generator"</span></span><br><span class="line">  value = &#123;Path@<span class="number">7374</span>&#125; </span><br><span class="line"> <span class="number">1</span> = &#123;LinkedHashMap$Entry@<span class="number">7371</span>&#125; <span class="string">"/generator.cmd/generator"</span> -&gt; </span><br><span class="line">  <span class="type">key</span> = <span class="string">"/generator.cmd/generator"</span></span><br><span class="line">  value = &#123;Path@<span class="number">7375</span>&#125; </span><br><span class="line"> <span class="number">2</span> = &#123;LinkedHashMap$Entry@<span class="number">7372</span>&#125; <span class="string">"/generator.cmd/c/generator"</span> -&gt; </span><br><span class="line">  <span class="type">key</span> = <span class="string">"/generator.cmd/c/generator"</span></span><br><span class="line">  value = &#123;Path@<span class="number">7376</span>&#125; </span><br><span class="line"> <span class="number">3</span> = &#123;LinkedHashMap$Entry@<span class="number">7373</span>&#125; <span class="string">"/generator.cmd/a/generator"</span> -&gt; </span><br><span class="line">  <span class="type">key</span> = <span class="string">"/generator.cmd/a/generator"</span></span><br><span class="line">  value = &#123;Path@<span class="number">7377</span>&#125;</span><br></pre></td></tr></table></figure></p>
<p>看来，按position排序已经生效。<br>然而我们打开网页访问，却发现排序功能没有实现～～～<br>待续。。。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://seven-cm.github.io/2019/03/02/Java-ByteBuffer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="seven-cm">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="seven-cm.blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2019/03/02/Java-ByteBuffer/" itemprop="url">
                  Java ByteBuffer
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-02T23:44:25+08:00">
                2019-03-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="ByteBuffer"><a href="#ByteBuffer" class="headerlink" title="ByteBuffer"></a>ByteBuffer</h1><p><code>ByteBuffer</code>是一个抽象类，继承<code>Buffer</code>类；我们先来看看Buffer在Java doc中的定义 <a href="https://docs.oracle.com/javase/8/docs/api/" target="_blank" rel="noopener">https://docs.oracle.com/javase/8/docs/api/</a><br><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">A container <span class="keyword">for</span> data <span class="keyword">of</span> a specific primitive <span class="keyword">type</span>.</span><br><span class="line">A <span class="keyword">buffer</span> <span class="keyword">is</span> a linear, finite <span class="keyword">sequence</span> <span class="keyword">of</span> elements <span class="keyword">of</span> a specific primitive <span class="keyword">type</span>. Aside from its content, the essential properties <span class="keyword">of</span> a <span class="keyword">buffer</span> are its capacity, limit, <span class="keyword">and</span> position:</span><br><span class="line"></span><br><span class="line">A <span class="keyword">buffer</span><span class="symbol">'s</span> capacity <span class="keyword">is</span> the number <span class="keyword">of</span> elements it contains. The capacity <span class="keyword">of</span> a <span class="keyword">buffer</span> <span class="keyword">is</span> never negative <span class="keyword">and</span> never changes.</span><br><span class="line"></span><br><span class="line">A <span class="keyword">buffer</span><span class="symbol">'s</span> limit <span class="keyword">is</span> the index <span class="keyword">of</span> the first element that should <span class="keyword">not</span> be read <span class="keyword">or</span> written. A <span class="keyword">buffer</span><span class="symbol">'s</span> limit <span class="keyword">is</span> never negative <span class="keyword">and</span> <span class="keyword">is</span> never greater than its capacity.</span><br><span class="line"></span><br><span class="line">A <span class="keyword">buffer</span><span class="symbol">'s</span> position <span class="keyword">is</span> the index <span class="keyword">of</span> the <span class="keyword">next</span> element <span class="keyword">to</span> be read <span class="keyword">or</span> written. A <span class="keyword">buffer</span><span class="symbol">'s</span> position <span class="keyword">is</span> never negative <span class="keyword">and</span> <span class="keyword">is</span> never greater than its limit.</span><br><span class="line"></span><br><span class="line">There <span class="keyword">is</span> one subclass <span class="keyword">of</span> this class <span class="keyword">for</span> each non-<span class="built_in">boolean</span> primitive <span class="keyword">type</span>.</span><br></pre></td></tr></table></figure></p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Buffer：可以看作是Java基本类型的数据的容器。包含<span class="number">4</span>个属性：</span><br><span class="line">capacity：容器的大小</span><br><span class="line"><span class="built_in">limit</span>：读写的边界，当<span class="built_in">position</span>到达<span class="built_in">limit</span>时，就表示将Buffer中的内容读完，或者将Buffer写满</span><br><span class="line"><span class="built_in">position</span>：表示当前可读写的指针，如果向Buffer对象中写入一个字节，那么就会向<span class="built_in">position</span>所指向的地址写入这个字节；如果是从Buffer读出一个字节，那么就会读出<span class="built_in">position</span>所指向的地址读出这个字节，读写完成后，<span class="built_in">position</span>+<span class="number">1</span></span><br><span class="line"></span><br><span class="line">上面几个属性的大小关系</span><br><span class="line"><span class="number">0</span> &lt;= mark &lt;= <span class="built_in">position</span> &lt;= <span class="built_in">limit</span> &lt;= capacity</span><br></pre></td></tr></table></figure>
<p>下面我们拿 smart-socket 来做一个说明。<br>大家也可以看看smart-socket的doc；链接在此<br><a href="https://smartboot.gitee.io/docs/smart-socket/quickStart.html" target="_blank" rel="noopener">https://smartboot.gitee.io/docs/smart-socket/quickStart.html</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.smartboot.socket.Protocol;</span><br><span class="line"><span class="keyword">import</span> org.smartboot.socket.transport.AioSession;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 三刀</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> V1.0 , 2018/8/25</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringProtocol</span> <span class="keyword">implements</span> <span class="title">Protocol</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INT_LENGTH = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解码方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> readBuffer AIO默认readBuffer到长度是512字节</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> session</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> eof</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">decode</span><span class="params">(ByteBuffer readBuffer, AioSession&lt;String&gt; session, <span class="keyword">boolean</span> eof)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//识别消息长度 这个判断是否有必要？</span></span><br><span class="line">        <span class="keyword">if</span> (readBuffer.remaining() &lt; INT_LENGTH) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//判断是否存在半包情况</span></span><br><span class="line">        <span class="keyword">int</span> len = readBuffer.getInt(<span class="number">0</span>);<span class="comment">//绝对读，获取整个byteBuffer的信息长度，具体构造看encode</span></span><br><span class="line">        <span class="keyword">if</span> (readBuffer.remaining() &lt; len) &#123;<span class="comment">//position到limit到距离位置</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        readBuffer.getInt();<span class="comment">//跳过byteBuffer前面4个字节用于记录msg的长度</span></span><br><span class="line">        <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[len - INT_LENGTH];</span><br><span class="line">        readBuffer.get(bytes);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String(bytes);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ByteBuffer <span class="title">encode</span><span class="params">(String msg, AioSession&lt;String&gt; session)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = msg.getBytes();</span><br><span class="line">        <span class="comment">//创建一个buffer容量为 数据长度（前面4个字节，用于存放消息长度） + 内容到长度</span></span><br><span class="line">        ByteBuffer buffer = ByteBuffer.allocate(INT_LENGTH + bytes.length);</span><br><span class="line">        buffer.putInt(INT_LENGTH+bytes.length);<span class="comment">//注意此处，增加4的长度（恰好是int在byte的长度），用于解码的时候，直接减掉4个字节的长度构造byte</span></span><br><span class="line">        buffer.put(bytes);</span><br><span class="line">        buffer.flip();</span><br><span class="line">        <span class="keyword">return</span> buffer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://seven-cm.github.io/2019/03/01/最近思考/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="seven-cm">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="seven-cm.blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2019/03/01/最近思考/" itemprop="url">
                  最近思考
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-01T07:40:39+08:00">
                2019-03-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h1><p>最近有这样的想法，就自己一个人做开发，感觉都没有交流，没有进步了～，真怕过2年后，自己就被淘汰了；而且如果说换工作都话，也没有一点竞争力。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://seven-cm.github.io/2018/10/19/docker-学习-使用alpine构建镜像/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="seven-cm">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="seven-cm.blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/10/19/docker-学习-使用alpine构建镜像/" itemprop="url">
                  docker-学习-使用 alpine 构建镜像
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-19T21:17:38+08:00">
                2018-10-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>该文章转载<code>一本正经的搞事情</code>的<a href="http://www.cnblogs.com/zhujingzhi/p/9746760.html#_labelTop" target="_blank" rel="noopener">基于 alpine 用 dockerfile 创建的 tomcat 镜像</a></p>
<ol>
<li>下载 alpine 镜像</li>
</ol>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">docker pull alpine</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>创建用于构建 jre 镜像的 cokerfile</li>
</ol>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/</span><br><span class="line"></span><br><span class="line">mkdir -p alpine_jre &amp;&amp; cd alpine_jre &amp;&amp; touch Dockerfile</span><br><span class="line"></span><br><span class="line">vi Dockerfile</span><br><span class="line"></span><br><span class="line"><span class="comment"># 基础镜像</span></span><br><span class="line"><span class="keyword">FROM</span> alpine</span><br><span class="line"></span><br><span class="line"><span class="comment"># 作者信息</span></span><br><span class="line"><span class="keyword">MAINTAINER</span> JRE Docker Maintainers <span class="string">"1024331014@qq.com"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改源</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"http://mirrors.aliyun.com/alpine/latest-stable/main/"</span> &gt; /etc/apk/repositories &amp;&amp; \</span></span><br><span class="line"><span class="bash">    <span class="built_in">echo</span> <span class="string">"http://mirrors.aliyun.com/alpine/latest-stable/community/"</span> &gt;&gt; /etc/apk/repositories</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装需要的软件</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apk update &amp;&amp; \</span></span><br><span class="line"><span class="bash">    apk add --no-cache ca-certificates &amp;&amp; \</span></span><br><span class="line"><span class="bash">    apk add --no-cache curl bash tree tzdata &amp;&amp; \</span></span><br><span class="line"><span class="bash">    cp -rf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义环境变量</span></span><br><span class="line"><span class="keyword">ENV</span> PATH /usr/local/bin:$&#123;PATH&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装JRE</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apk add --nocache openjdk8-jre-base &amp;&amp; \</span></span><br><span class="line"><span class="bash">    rm -rf /var/cache/apk/*</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> &#123; \</span></span><br><span class="line"><span class="bash">        <span class="built_in">echo</span> <span class="string">'#!/bin/sh'</span>; \</span></span><br><span class="line"><span class="bash">        <span class="built_in">echo</span> <span class="string">'set -e'</span>; \</span></span><br><span class="line"><span class="bash">        <span class="built_in">echo</span>; \</span></span><br><span class="line"><span class="bash">        <span class="built_in">echo</span> <span class="string">'dirname "$(dirname "$(readlink -f "$(which javac || which java)")")"'</span>; \</span></span><br><span class="line"><span class="bash">     &#125; &gt; /usr/<span class="built_in">local</span>/bin/docker-java-home \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chmod +x /usr/<span class="built_in">local</span>/bin/docker-java-home</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> JAVA_HOME /usr/lib/jvm/default-jvm</span><br><span class="line"><span class="keyword">ENV</span> PATH $&#123;PATH&#125;:$&#123;JAVA_HOME&#125;/bin:$&#123;JAVA_HOME&#125;/jre/bin</span><br><span class="line"><span class="keyword">ENV</span> JAVA_VERSION <span class="number">8</span>u71</span><br><span class="line"><span class="keyword">ENV</span> JAVA_ALPINE_VERSION <span class="number">8.171</span>.<span class="number">11</span>-r0</span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">set</span> -x \</span></span><br><span class="line"><span class="bash">    \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk add --no-cache \</span></span><br><span class="line"><span class="bash">    \</span></span><br><span class="line"><span class="bash">    openjdk8-jre=<span class="string">"<span class="variable">$JAVA_ALPINE_VERSION</span>"</span></span></span><br></pre></td></tr></table></figure>
<ol start="3">
<li>构建 jre 镜像</li>
</ol>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">docker</span> <span class="keyword">build </span>-t alpine_jre .</span><br></pre></td></tr></table></figure>
<blockquote>
<p>update 20190606 若直接使用上面的代码，构建会失败，请访问：<a href="https://pkgs.alpinelinux.org/packages" target="_blank" rel="noopener">https://pkgs.alpinelinux.org/packages</a> 输入 jdk 信息，查询是否存在该 jre 的版本包。</p>
</blockquote>
<blockquote>
<p>注意：如果在构建中出现 WARNING: Ignoring APKINDEX.d4f262b4.tar.gz: No such file or directory 则说明 docker 不能链接到外网。解决方法如下：</p>
</blockquote>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">1.查看宿主机的nameserver</span><br><span class="line">cat /etc/resolv.conf</span><br><span class="line"><span class="built_in">..</span>.</span><br><span class="line"><span class="built_in">..</span>.</span><br><span class="line">nameserver xxx.xxx.xxx.xxx</span><br><span class="line">2.创建或修改/etc/default/docker加入以下内容</span><br><span class="line"><span class="attribute">DOCKER_OPTS</span>=<span class="string">"--dns xxx.xxx.xxx.xxx"</span></span><br><span class="line">3.最后重启docker</span><br><span class="line">systemctl restart docker</span><br><span class="line"></span><br><span class="line">【注意】：虽然在docker中已经能上网了，但是在【gpg --keyserver ha.pool.sks-keyservers.net --recv-keys 05AB33110949707C93A279E3D3EFE6B686867BA6】的时候，会出现：gpg: keyserver receive failed:<span class="built_in"> Connection </span>refused这样的问题；出现</span><br><span class="line">此类问题，也是网络连接的问题；此时请docker <span class="builtin-name">run</span> -it imageID</span><br><span class="line">进入后，</span><br><span class="line">cat /etc/resolv.conf</span><br><span class="line"></span><br><span class="line">如果发现有内网地址的，请将内网地址删除掉如：</span><br><span class="line"></span><br><span class="line"><span class="comment"># Generated by NetworkManager</span></span><br><span class="line">nameserver 192.168.1.1</span><br><span class="line">nameserver 8.8.8.8</span><br><span class="line">nameserver 114.114.114.114</span><br><span class="line"></span><br><span class="line">则需删除掉 nameserver 192.168.1.1 否则在gpg的时候，还是会一直报 gpg: keyserver receive failed:<span class="built_in"> Connection </span>refused</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>创建用于构建 tomcat 镜像的 dockerfile</li>
</ol>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/</span><br><span class="line">mkdir -p jre_tomcat &amp;&amp; cd jre_tomcat &amp;&amp; touch Dockerfile</span><br><span class="line">vi Dockerfile</span><br><span class="line"></span><br><span class="line"><span class="comment">#基础镜像</span></span><br><span class="line"><span class="keyword">FROM</span> alpine_jre</span><br><span class="line"></span><br><span class="line"><span class="comment"># 作者信息</span></span><br><span class="line"><span class="keyword">MAINTAINER</span> tomcat Docker Maintainers <span class="string">"1024331014@qq.com"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义tomcat变量(如果有其他的可以在这里加)</span></span><br><span class="line"><span class="keyword">ENV</span> CATALINA_HOME /usr/local/tomcat</span><br><span class="line"><span class="keyword">ENV</span> PATH $CATALINA_HOME/bin:$PATH</span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mkdir -p <span class="string">"<span class="variable">$CATALINA_HOME</span>"</span></span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> <span class="variable">$CATALINA_HOME</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># let "Tomcat Native" live somewhere isolated</span></span><br><span class="line"><span class="keyword">ENV</span> TOMCAT_NATIVE_LIBDIR $CATALINA_HOME/native-jni-lib</span><br><span class="line"><span class="keyword">ENV</span> LD_LIBRARY_PATH $&#123;LD_LIBRARY_PATH:+$LD_LIBRARY_PATH:&#125;$TOMCAT_NATIVE_LIBDIR</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apk add --no-cache gnupg</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># see http://archive.apache.org/dist/tomcat/tomcat-$TOMCAT_MAJOR/KEYS</span></span><br><span class="line"><span class="comment"># see also "update.sh" (https://github.com/docker-library/tomcat/blob/master/update.sh)</span></span><br><span class="line"><span class="keyword">ENV</span> GPG_KEYS <span class="number">05</span>AB33110949707C93A279E3D3EFE6B686867BA6 <span class="number">07</span>E48665A34DCAFAE522E5E6266191C37C037D42 <span class="number">47309207</span>D818FFD8DCD3F83F1931D684307A10A5 <span class="number">541</span>FBE7D8F78B25E055DDEE13C370389288584E7 <span class="number">61</span>B832AC2F1C5A90F0F9B00A1C506407564C17A3 <span class="number">713</span>DA88BE50911535FE716F5208B0AB1D63011C7 <span class="number">79</span>F7026C690BAA50B92CD8B66A3AD3F4F22C4FED <span class="number">9</span>BA44C2621385CB966EBA586F72C284D731FABEE A27677289986DB50844682F8ACB77FC2E86E29AC A9C5DF4D22E99998D9875A5110C01C5A2F6059E7 DCFD35E0BF8CA7344752DE8B6FB21E8933C60243 F3A04C595DB5B6A5F1ECA43E3B7BBB100D811BBE F7DA48BB64BCB84ECBA7EE6935CD23C10D498E23</span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">set</span> -ex; \</span></span><br><span class="line"><span class="bash">        <span class="keyword">for</span> key <span class="keyword">in</span> <span class="variable">$GPG_KEYS</span>; <span class="keyword">do</span> \</span></span><br><span class="line"><span class="bash">                gpg --keyserver ha.pool.sks-keyservers.net --recv-keys <span class="string">"<span class="variable">$key</span>"</span>; \</span></span><br><span class="line"><span class="bash">        <span class="keyword">done</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义tomcat版本</span></span><br><span class="line"><span class="keyword">ENV</span> TOMCAT_MAJOR <span class="number">8</span></span><br><span class="line"><span class="keyword">ENV</span> TOMCAT_VERSION <span class="number">8.0</span>.<span class="number">53</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载</span></span><br><span class="line"><span class="comment"># https://issues.apache.org/jira/browse/INFRA-8753?focusedCommentId=14735394#comment-14735394</span></span><br><span class="line"><span class="keyword">ENV</span> TOMCAT_TGZ_URL https://www.apache.org/dyn/closer.cgi?action=download&amp;filename=tomcat/tomcat-$TOMCAT_MAJOR/v$TOMCAT_VERSION/bin/apache-tomcat-$TOMCAT_VERSION.tar.gz</span><br><span class="line"><span class="comment"># not all the mirrors actually carry the .asc files :'(</span></span><br><span class="line"><span class="keyword">ENV</span> TOMCAT_ASC_URL http://archive.apache.org/dist/tomcat/tomcat-$TOMCAT_MAJOR/v$TOMCAT_VERSION/bin/apache-tomcat-$TOMCAT_VERSION.tar.gz.asc</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">set</span> -x \</span></span><br><span class="line"><span class="bash">        \</span></span><br><span class="line"><span class="bash">        &amp;&amp; apk add --no-cache --virtual .fetch-deps \</span></span><br><span class="line"><span class="bash">                ca-certificates \</span></span><br><span class="line"><span class="bash">                tar \</span></span><br><span class="line"><span class="bash">                openssl \</span></span><br><span class="line"><span class="bash">        &amp;&amp; wget -O tomcat.tar.gz <span class="string">"<span class="variable">$TOMCAT_TGZ_URL</span>"</span> \</span></span><br><span class="line"><span class="bash">        &amp;&amp; wget -O tomcat.tar.gz.asc <span class="string">"<span class="variable">$TOMCAT_ASC_URL</span>"</span> \</span></span><br><span class="line"><span class="bash">        &amp;&amp; gpg --batch --verify tomcat.tar.gz.asc tomcat.tar.gz \</span></span><br><span class="line"><span class="bash">        &amp;&amp; tar -xvf tomcat.tar.gz --strip-components=1 \</span></span><br><span class="line"><span class="bash">        &amp;&amp; rm bin/*.bat \</span></span><br><span class="line"><span class="bash">        &amp;&amp; rm tomcat.tar.gz* \</span></span><br><span class="line"><span class="bash">        \</span></span><br><span class="line"><span class="bash">        &amp;&amp; nativeBuildDir=<span class="string">"<span class="variable">$(mktemp -d)</span>"</span> \</span></span><br><span class="line"><span class="bash">        &amp;&amp; tar -xvf bin/tomcat-native.tar.gz -C <span class="string">"<span class="variable">$nativeBuildDir</span>"</span> --strip-components=1 \</span></span><br><span class="line"><span class="bash">        &amp;&amp; apk add --no-cache --virtual .native-build-deps \</span></span><br><span class="line"><span class="bash">                apr-dev \</span></span><br><span class="line"><span class="bash">                dpkg-dev dpkg \</span></span><br><span class="line"><span class="bash">                gcc \</span></span><br><span class="line"><span class="bash">                libc-dev \</span></span><br><span class="line"><span class="bash">                make \</span></span><br><span class="line"><span class="bash">                <span class="string">"openjdk<span class="variable">$&#123;JAVA_VERSION%%[-~bu]*&#125;</span>"</span>=<span class="string">"<span class="variable">$JAVA_ALPINE_VERSION</span>"</span> \</span></span><br><span class="line"><span class="bash">                openssl-dev \</span></span><br><span class="line"><span class="bash">        &amp;&amp; ( \</span></span><br><span class="line"><span class="bash">                <span class="built_in">export</span> CATALINA_HOME=<span class="string">"<span class="variable">$PWD</span>"</span> \</span></span><br><span class="line"><span class="bash">                &amp;&amp; <span class="built_in">cd</span> <span class="string">"<span class="variable">$nativeBuildDir</span>/native"</span> \</span></span><br><span class="line"><span class="bash">                &amp;&amp; gnuArch=<span class="string">"<span class="variable">$(dpkg-architecture --query DEB_BUILD_GNU_TYPE)</span>"</span> \</span></span><br><span class="line"><span class="bash">                &amp;&amp; ./configure \</span></span><br><span class="line"><span class="bash">                        --build=<span class="string">"<span class="variable">$gnuArch</span>"</span> \</span></span><br><span class="line"><span class="bash">                        --libdir=<span class="string">"<span class="variable">$TOMCAT_NATIVE_LIBDIR</span>"</span> \</span></span><br><span class="line"><span class="bash">                        --prefix=<span class="string">"<span class="variable">$CATALINA_HOME</span>"</span> \</span></span><br><span class="line"><span class="bash">                        --with-apr=<span class="string">"<span class="variable">$(which apr-1-config)</span>"</span> \</span></span><br><span class="line"><span class="bash">                        --with-java-home=<span class="string">"<span class="variable">$(docker-java-home)</span>"</span> \</span></span><br><span class="line"><span class="bash">                        --with-ssl=yes \</span></span><br><span class="line"><span class="bash">                &amp;&amp; make -j$(getconf _NPROCESSORS_ONLN) \</span></span><br><span class="line"><span class="bash">                &amp;&amp; make install \</span></span><br><span class="line"><span class="bash">        ) \</span></span><br><span class="line"><span class="bash">        &amp;&amp; runDeps=<span class="string">"<span class="variable">$( \</span></span></span></span><br><span class="line"><span class="bash">                scanelf --needed --nobanner --recursive <span class="string">"<span class="variable">$TOMCAT_NATIVE_LIBDIR</span>"</span> \</span></span><br><span class="line"><span class="bash">                        | awk <span class="string">'&#123; gsub(/,/, "\nso:", $2); print "so:" $2 &#125;'</span> \</span></span><br><span class="line"><span class="bash">                        | sort -u \</span></span><br><span class="line"><span class="bash">                        | xargs -r apk info --installed \</span></span><br><span class="line"><span class="bash">                        | sort -u \</span></span><br><span class="line"><span class="bash">        )<span class="string">" \</span></span></span><br><span class="line"><span class="bash">        &amp;&amp; apk add --virtual .tomcat-native-rundeps <span class="variable">$runDeps</span> \</span></span><br><span class="line"><span class="bash">        &amp;&amp; apk del .fetch-deps .native-build-deps \</span></span><br><span class="line"><span class="bash">        &amp;&amp; rm -rf <span class="string">"<span class="variable">$nativeBuildDir</span>"</span> \</span></span><br><span class="line"><span class="bash">        &amp;&amp; rm bin/tomcat-native.tar.gz</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># verify Tomcat Native is working properly</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">set</span> -e \</span></span><br><span class="line"><span class="bash">        &amp;&amp; nativeLines=<span class="string">"<span class="variable">$(catalina.sh configtest 2&gt;&amp;1)</span>"</span> \</span></span><br><span class="line"><span class="bash">        &amp;&amp; nativeLines=<span class="string">"<span class="variable">$(echo "$nativeLines" | grep 'Apache Tomcat Native')</span>"</span> \</span></span><br><span class="line"><span class="bash">        &amp;&amp; nativeLines=<span class="string">"<span class="variable">$(echo "$nativeLines" | sort -u)</span>"</span> \</span></span><br><span class="line"><span class="bash">        &amp;&amp; <span class="keyword">if</span> ! <span class="built_in">echo</span> <span class="string">"<span class="variable">$nativeLines</span>"</span> | grep <span class="string">'INFO: Loaded APR based Apache Tomcat Native library'</span> &gt;&amp;2; <span class="keyword">then</span> \</span></span><br><span class="line"><span class="bash">                <span class="built_in">echo</span> &gt;&amp;2 <span class="string">"<span class="variable">$nativeLines</span>"</span>; \</span></span><br><span class="line"><span class="bash">                <span class="built_in">exit</span> 1; \</span></span><br><span class="line"><span class="bash">        <span class="keyword">fi</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 暴露8080端口</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"><span class="comment"># 执行命令</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"catalina.sh"</span>, <span class="string">"run"</span>]</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>update 20190606 可能 tomcat 的版本已经过时，请修改相关的版本号，以及相关 tomcat verify 的地址；查看地址可以直接进 tomcat 的下载地址，然后点击 pgp 链接即可获取.asc 的链接地址。</p>
</blockquote>
<ol start="5">
<li>构建 tomcat 镜像</li>
</ol>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t tomcat:<span class="number">1.0</span> .</span><br></pre></td></tr></table></figure>
<ol start="6">
<li>创建用于构建 tomcat_web 的 dockerfile 以及启动 tomcat 脚本</li>
</ol>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br></pre></td><td class="code"><pre><span class="line"> cd /opt/</span><br><span class="line"> mkdir tomcat_web &amp;&amp; cd tomcat_web &amp;&amp; touch Dockerfile &amp;&amp; touch start.sh</span><br><span class="line"> vi start.sh</span><br><span class="line"></span><br><span class="line"> #!/bin/sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># Licensed to the Apache Software Foundation (ASF) under one or more</span></span><br><span class="line"><span class="comment"># contributor license agreements.  See the NOTICE file distributed with</span></span><br><span class="line"><span class="comment"># this work for additional information regarding copyright ownership.</span></span><br><span class="line"><span class="comment"># The ASF licenses this file to You under the Apache License, Version 2.0</span></span><br><span class="line"><span class="comment"># (the "License"); you may not use this file except in compliance with</span></span><br><span class="line"><span class="comment"># the License.  You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#     http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"># distributed under the License is distributed on an "AS IS" BASIS,</span></span><br><span class="line"><span class="comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"># See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"># limitations under the License.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -----------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># Control Script for the CATALINA Server</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Environment Variable Prerequisites</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   Do not set the variables in this script. Instead put them into a script</span></span><br><span class="line"><span class="comment">#   setenv.sh in CATALINA_BASE/bin to keep your customizations separate.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   CATALINA_HOME   May point at your Catalina "build" directory.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   CATALINA_BASE   (Optional) Base directory for resolving dynamic portions</span></span><br><span class="line"><span class="comment">#                   of a Catalina installation.  If not present, resolves to</span></span><br><span class="line"><span class="comment">#                   the same directory that CATALINA_HOME points to.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   CATALINA_OUT    (Optional) Full path to a file where stdout and stderr</span></span><br><span class="line"><span class="comment">#                   will be redirected.</span></span><br><span class="line"><span class="comment">#                   Default is $CATALINA_BASE/logs/catalina.out</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   CATALINA_OPTS   (Optional) Java runtime options used when the "start",</span></span><br><span class="line"><span class="comment">#                   "run" or "debug" command is executed.</span></span><br><span class="line"><span class="comment">#                   Include here and not in JAVA_OPTS all options, that should</span></span><br><span class="line"><span class="comment">#                   only be used by Tomcat itself, not by the stop process,</span></span><br><span class="line"><span class="comment">#                   the version command etc.</span></span><br><span class="line"><span class="comment">#                   Examples are heap size, GC logging, JMX ports etc.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   CATALINA_TMPDIR (Optional) Directory path location of temporary directory</span></span><br><span class="line"><span class="comment">#                   the JVM should use (java.io.tmpdir).  Defaults to</span></span><br><span class="line"><span class="comment">#                   $CATALINA_BASE/temp.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   JAVA_HOME       Must point at your Java Development Kit installation.</span></span><br><span class="line"><span class="comment">#                   Required to run the with the "debug" argument.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   JRE_HOME        Must point at your Java Runtime installation.</span></span><br><span class="line"><span class="comment">#                   Defaults to JAVA_HOME if empty. If JRE_HOME and JAVA_HOME</span></span><br><span class="line"><span class="comment">#                   are both set, JRE_HOME is used.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   JAVA_OPTS       (Optional) Java runtime options used when any command</span></span><br><span class="line"><span class="comment">#                   is executed.</span></span><br><span class="line"><span class="comment">#                   Include here and not in CATALINA_OPTS all options, that</span></span><br><span class="line"><span class="comment">#                   should be used by Tomcat and also by the stop process,</span></span><br><span class="line"><span class="comment">#                   the version command etc.</span></span><br><span class="line"><span class="comment">#                   Most options should go into CATALINA_OPTS.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   JAVA_ENDORSED_DIRS (Optional) Lists of of colon separated directories</span></span><br><span class="line"><span class="comment">#                   containing some jars in order to allow replacement of APIs</span></span><br><span class="line"><span class="comment">#                   created outside of the JCP (i.e. DOM and SAX from W3C).</span></span><br><span class="line"><span class="comment">#                   It can also be used to update the XML parser implementation.</span></span><br><span class="line"><span class="comment">#                   Defaults to $CATALINA_HOME/endorsed.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   JPDA_TRANSPORT  (Optional) JPDA transport used when the "jpda start"</span></span><br><span class="line"><span class="comment">#                   command is executed. The default is "dt_socket".</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   JPDA_ADDRESS    (Optional) Java runtime options used when the "jpda start"</span></span><br><span class="line"><span class="comment">#                   command is executed. The default is localhost:8000.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   JPDA_SUSPEND    (Optional) Java runtime options used when the "jpda start"</span></span><br><span class="line"><span class="comment">#                   command is executed. Specifies whether JVM should suspend</span></span><br><span class="line"><span class="comment">#                   execution immediately after startup. Default is "n".</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   JPDA_OPTS       (Optional) Java runtime options used when the "jpda start"</span></span><br><span class="line"><span class="comment">#                   command is executed. If used, JPDA_TRANSPORT, JPDA_ADDRESS,</span></span><br><span class="line"><span class="comment">#                   and JPDA_SUSPEND are ignored. Thus, all required jpda</span></span><br><span class="line"><span class="comment">#                   options MUST be specified. The default is:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#                   -agentlib:jdwp=transport=$JPDA_TRANSPORT,</span></span><br><span class="line"><span class="comment">#                       address=$JPDA_ADDRESS,server=y,suspend=$JPDA_SUSPEND</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   JSSE_OPTS       (Optional) Java runtime options used to control the TLS</span></span><br><span class="line"><span class="comment">#                   implementation when JSSE is used. Default is:</span></span><br><span class="line"><span class="comment">#                   "-Djdk.tls.ephemeralDHKeySize=2048"</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   CATALINA_PID    (Optional) Path of the file which should contains the pid</span></span><br><span class="line"><span class="comment">#                   of the catalina startup java process, when start (fork) is</span></span><br><span class="line"><span class="comment">#                   used</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   LOGGING_CONFIG  (Optional) Override Tomcat's logging config file</span></span><br><span class="line"><span class="comment">#                   Example (all one line)</span></span><br><span class="line"><span class="comment">#                   LOGGING_CONFIG="-Djava.util.logging.config.file=$CATALINA_BASE/conf/logging.properties"</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   LOGGING_MANAGER (Optional) Override Tomcat's logging manager</span></span><br><span class="line"><span class="comment">#                   Example (all one line)</span></span><br><span class="line"><span class="comment">#                   LOGGING_MANAGER="-Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager"</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   USE_NOHUP       (Optional) If set to the string true the start command will</span></span><br><span class="line"><span class="comment">#                   use nohup so that the Tomcat process will ignore any hangup</span></span><br><span class="line"><span class="comment">#                   signals. Default is "false" unless running on HP-UX in which</span></span><br><span class="line"><span class="comment">#                   case the default is "true"</span></span><br><span class="line"><span class="comment"># -----------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># OS specific support.  $var _must_ be set to either true or false.</span></span><br><span class="line"><span class="attribute">cygwin</span>=<span class="literal">false</span></span><br><span class="line"><span class="attribute">darwin</span>=<span class="literal">false</span></span><br><span class="line"><span class="attribute">os400</span>=<span class="literal">false</span></span><br><span class="line"><span class="attribute">hpux</span>=<span class="literal">false</span></span><br><span class="line">case <span class="string">"`uname`"</span> <span class="keyword">in</span></span><br><span class="line">CYGWIN*) <span class="attribute">cygwin</span>=<span class="literal">true</span>;;</span><br><span class="line">Darwin*) <span class="attribute">darwin</span>=<span class="literal">true</span>;;</span><br><span class="line">OS400*) <span class="attribute">os400</span>=<span class="literal">true</span>;;</span><br><span class="line">HP-UX*) <span class="attribute">hpux</span>=<span class="literal">true</span>;;</span><br><span class="line">esac</span><br><span class="line"></span><br><span class="line"><span class="comment"># resolve links - $0 may be a softlink</span></span><br><span class="line"><span class="attribute">PRG</span>=<span class="string">"<span class="variable">$0</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> [ -h <span class="string">"<span class="variable">$PRG</span>"</span> ]; <span class="keyword">do</span></span><br><span class="line">  <span class="attribute">ls</span>=`ls -ld <span class="string">"<span class="variable">$PRG</span>"</span>`</span><br><span class="line">  <span class="attribute">link</span>=`expr <span class="string">"<span class="variable">$ls</span>"</span> : <span class="string">'.*-&gt; \(.*\)$'</span>`</span><br><span class="line">  <span class="keyword">if</span> expr <span class="string">"<span class="variable">$link</span>"</span> : <span class="string">'/.*'</span> &gt; /dev/<span class="literal">null</span>; then</span><br><span class="line">    <span class="attribute">PRG</span>=<span class="string">"<span class="variable">$link</span>"</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="attribute">PRG</span>=`dirname <span class="string">"<span class="variable">$PRG</span>"</span>`/<span class="string">"<span class="variable">$link</span>"</span></span><br><span class="line">  fi</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get standard environment variables</span></span><br><span class="line"><span class="attribute">PRGDIR</span>=`dirname <span class="string">"<span class="variable">$PRG</span>"</span>`</span><br><span class="line"></span><br><span class="line"><span class="comment"># Only set CATALINA_HOME if not already set</span></span><br><span class="line">[ -z <span class="string">"<span class="variable">$CATALINA_HOME</span>"</span> ] &amp;&amp; <span class="attribute">CATALINA_HOME</span>=`cd <span class="string">"<span class="variable">$PRGDIR</span>/.."</span> &gt;/dev/<span class="literal">null</span>; pwd`</span><br><span class="line"></span><br><span class="line"><span class="comment"># Copy CATALINA_BASE from CATALINA_HOME if not already set</span></span><br><span class="line">[ -z <span class="string">"<span class="variable">$CATALINA_BASE</span>"</span> ] &amp;&amp; <span class="attribute">CATALINA_BASE</span>=<span class="string">"<span class="variable">$CATALINA_HOME</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Ensure that any user defined CLASSPATH variables are not used on startup,</span></span><br><span class="line"><span class="comment"># but allow them to be specified in setenv.sh, in rare case when it is needed.</span></span><br><span class="line">CLASSPATH=</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -r <span class="string">"<span class="variable">$CATALINA_BASE</span>/bin/setenv.sh"</span> ]; then</span><br><span class="line">  . <span class="string">"<span class="variable">$CATALINA_BASE</span>/bin/setenv.sh"</span></span><br><span class="line">elif [ -r <span class="string">"<span class="variable">$CATALINA_HOME</span>/bin/setenv.sh"</span> ]; then</span><br><span class="line">  . <span class="string">"<span class="variable">$CATALINA_HOME</span>/bin/setenv.sh"</span></span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="comment"># For Cygwin, ensure paths are in UNIX format before anything is touched</span></span><br><span class="line"><span class="keyword">if</span> <span class="variable">$cygwin</span>; then</span><br><span class="line">  [ -n <span class="string">"<span class="variable">$JAVA_HOME</span>"</span> ] &amp;&amp; <span class="attribute">JAVA_HOME</span>=`cygpath --unix <span class="string">"<span class="variable">$JAVA_HOME</span>"</span>`</span><br><span class="line">  [ -n <span class="string">"<span class="variable">$JRE_HOME</span>"</span> ] &amp;&amp; <span class="attribute">JRE_HOME</span>=`cygpath --unix <span class="string">"<span class="variable">$JRE_HOME</span>"</span>`</span><br><span class="line">  [ -n <span class="string">"<span class="variable">$CATALINA_HOME</span>"</span> ] &amp;&amp; <span class="attribute">CATALINA_HOME</span>=`cygpath --unix <span class="string">"<span class="variable">$CATALINA_HOME</span>"</span>`</span><br><span class="line">  [ -n <span class="string">"<span class="variable">$CATALINA_BASE</span>"</span> ] &amp;&amp; <span class="attribute">CATALINA_BASE</span>=`cygpath --unix <span class="string">"<span class="variable">$CATALINA_BASE</span>"</span>`</span><br><span class="line">  [ -n <span class="string">"<span class="variable">$CLASSPATH</span>"</span> ] &amp;&amp; <span class="attribute">CLASSPATH</span>=`cygpath --path --unix <span class="string">"<span class="variable">$CLASSPATH</span>"</span>`</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="comment"># Ensure that neither CATALINA_HOME nor CATALINA_BASE contains a colon</span></span><br><span class="line"><span class="comment"># as this is used as the separator in the classpath and Java provides no</span></span><br><span class="line"><span class="comment"># mechanism for escaping if the same character appears in the path.</span></span><br><span class="line">case <span class="variable">$CATALINA_HOME</span> <span class="keyword">in</span></span><br><span class="line">  *:*) echo <span class="string">"Using CATALINA_HOME:   <span class="variable">$CATALINA_HOME</span>"</span>;</span><br><span class="line">       echo <span class="string">"Unable to start as CATALINA_HOME contains a colon (:) character"</span>;</span><br><span class="line">       exit 1;</span><br><span class="line">esac</span><br><span class="line">case <span class="variable">$CATALINA_BASE</span> <span class="keyword">in</span></span><br><span class="line">  *:*) echo <span class="string">"Using CATALINA_BASE:   <span class="variable">$CATALINA_BASE</span>"</span>;</span><br><span class="line">       echo <span class="string">"Unable to start as CATALINA_BASE contains a colon (:) character"</span>;</span><br><span class="line">       exit 1;</span><br><span class="line">esac</span><br><span class="line"></span><br><span class="line"><span class="comment"># For OS400</span></span><br><span class="line"><span class="keyword">if</span> <span class="variable">$os400</span>; then</span><br><span class="line">  # <span class="builtin-name">Set</span> job priority <span class="keyword">to</span> standard <span class="keyword">for</span> interactive (interactive - 6) by using</span><br><span class="line">  # the interactive priority - 6, the helper threads that respond <span class="keyword">to</span> requests</span><br><span class="line">  # will be running at the same priority as interactive jobs.</span><br><span class="line">  <span class="attribute">COMMAND</span>=<span class="string">'chgjob job('</span><span class="variable">$JOBNAME</span><span class="string">') runpty(6)'</span></span><br><span class="line"> <span class="built_in"> system </span><span class="variable">$COMMAND</span></span><br><span class="line"></span><br><span class="line">  # <span class="builtin-name">Enable</span> multi threading</span><br><span class="line">  <span class="builtin-name">export</span> <span class="attribute">QIBM_MULTI_THREADED</span>=Y</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get standard Java environment variables</span></span><br><span class="line"><span class="keyword">if</span> <span class="variable">$os400</span>; then</span><br><span class="line">  # -r will Only work on the os400 <span class="keyword">if</span> the files are:</span><br><span class="line">  # 1. owned by the user</span><br><span class="line">  # 2. owned by the PRIMARY<span class="built_in"> group </span>of the user</span><br><span class="line">  # this will <span class="keyword">not</span> work <span class="keyword">if</span> the<span class="built_in"> user </span>belongs <span class="keyword">in</span> secondary groups</span><br><span class="line">  . <span class="string">"<span class="variable">$CATALINA_HOME</span>"</span>/bin/setclasspath.sh</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="keyword">if</span> [ -r <span class="string">"<span class="variable">$CATALINA_HOME</span>"</span>/bin/setclasspath.sh ]; then</span><br><span class="line">    . <span class="string">"<span class="variable">$CATALINA_HOME</span>"</span>/bin/setclasspath.sh</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    echo <span class="string">"Cannot find <span class="variable">$CATALINA_HOME</span>/bin/setclasspath.sh"</span></span><br><span class="line">    echo <span class="string">"This file is needed to run this program"</span></span><br><span class="line">    exit 1</span><br><span class="line">  fi</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add on extra jar files to CLASSPATH</span></span><br><span class="line"><span class="keyword">if</span> [ ! -z <span class="string">"<span class="variable">$CLASSPATH</span>"</span> ] ; then</span><br><span class="line">  <span class="attribute">CLASSPATH</span>=<span class="string">"<span class="variable">$CLASSPATH</span>"</span>:</span><br><span class="line">fi</span><br><span class="line"><span class="attribute">CLASSPATH</span>=<span class="string">"<span class="variable">$CLASSPATH</span>"</span><span class="string">"<span class="variable">$CATALINA_HOME</span>"</span>/bin/bootstrap.jar</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$CATALINA_OUT</span>"</span> ] ; then</span><br><span class="line">  <span class="attribute">CATALINA_OUT</span>=<span class="string">"<span class="variable">$CATALINA_BASE</span>"</span>/logs/catalina.out</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$CATALINA_TMPDIR</span>"</span> ] ; then</span><br><span class="line">  # Define the java.io.tmpdir <span class="keyword">to</span> use <span class="keyword">for</span> Catalina</span><br><span class="line">  <span class="attribute">CATALINA_TMPDIR</span>=<span class="string">"<span class="variable">$CATALINA_BASE</span>"</span>/temp</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add tomcat-juli.jar to classpath</span></span><br><span class="line"><span class="comment"># tomcat-juli.jar can be over-ridden per instance</span></span><br><span class="line"><span class="keyword">if</span> [ -r <span class="string">"<span class="variable">$CATALINA_BASE</span>/bin/tomcat-juli.jar"</span> ] ; then</span><br><span class="line">  <span class="attribute">CLASSPATH</span>=<span class="variable">$CLASSPATH</span>:$CATALINA_BASE/bin/tomcat-juli.jar</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="attribute">CLASSPATH</span>=<span class="variable">$CLASSPATH</span>:$CATALINA_HOME/bin/tomcat-juli.jar</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="comment"># Bugzilla 37848: When no TTY is available, don't output to console</span></span><br><span class="line"><span class="attribute">have_tty</span>=0</span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"`tty`"</span> != <span class="string">"not a tty"</span> ]; then</span><br><span class="line">    <span class="attribute">have_tty</span>=1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="comment"># For Cygwin, switch paths to Windows format before running java</span></span><br><span class="line"><span class="keyword">if</span> <span class="variable">$cygwin</span>; then</span><br><span class="line">  <span class="attribute">JAVA_HOME</span>=`cygpath --absolute --windows <span class="string">"<span class="variable">$JAVA_HOME</span>"</span>`</span><br><span class="line">  <span class="attribute">JRE_HOME</span>=`cygpath --absolute --windows <span class="string">"<span class="variable">$JRE_HOME</span>"</span>`</span><br><span class="line">  <span class="attribute">CATALINA_HOME</span>=`cygpath --absolute --windows <span class="string">"<span class="variable">$CATALINA_HOME</span>"</span>`</span><br><span class="line">  <span class="attribute">CATALINA_BASE</span>=`cygpath --absolute --windows <span class="string">"<span class="variable">$CATALINA_BASE</span>"</span>`</span><br><span class="line">  <span class="attribute">CATALINA_TMPDIR</span>=`cygpath --absolute --windows <span class="string">"<span class="variable">$CATALINA_TMPDIR</span>"</span>`</span><br><span class="line">  <span class="attribute">CLASSPATH</span>=`cygpath --path --windows <span class="string">"<span class="variable">$CLASSPATH</span>"</span>`</span><br><span class="line">  <span class="attribute">JAVA_ENDORSED_DIRS</span>=`cygpath --path --windows <span class="string">"<span class="variable">$JAVA_ENDORSED_DIRS</span>"</span>`</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$JSSE_OPTS</span>"</span> ] ; then</span><br><span class="line">  <span class="attribute">JSSE_OPTS</span>=<span class="string">"-Djdk.tls.ephemeralDHKeySize=2048"</span></span><br><span class="line">fi</span><br><span class="line"><span class="attribute">JAVA_OPTS</span>=<span class="string">"<span class="variable">$JAVA_OPTS</span> <span class="variable">$JSSE_OPTS</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Register custom URL handlers</span></span><br><span class="line"><span class="comment"># Do this here so custom URL handles (specifically 'war:...') can be used in the security policy</span></span><br><span class="line"><span class="attribute">JAVA_OPTS</span>=<span class="string">"<span class="variable">$JAVA_OPTS</span> -Djava.protocol.handler.pkgs=org.apache.catalina.webresources"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set juli LogManager config file if it is present and an override has not been issued</span></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$LOGGING_CONFIG</span>"</span> ]; then</span><br><span class="line">  <span class="keyword">if</span> [ -r <span class="string">"<span class="variable">$CATALINA_BASE</span>"</span>/conf/logging.properties ]; then</span><br><span class="line">    <span class="attribute">LOGGING_CONFIG</span>=<span class="string">"-Djava.util.logging.config.file=<span class="variable">$CATALINA_BASE</span>/conf/logging.properties"</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    # Bugzilla 45585</span><br><span class="line">    <span class="attribute">LOGGING_CONFIG</span>=<span class="string">"-Dnop"</span></span><br><span class="line">  fi</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$LOGGING_MANAGER</span>"</span> ]; then</span><br><span class="line">  <span class="attribute">LOGGING_MANAGER</span>=<span class="string">"-Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager"</span></span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="comment"># Uncomment the following line to make the umask available when using the</span></span><br><span class="line"><span class="comment"># org.apache.catalina.security.SecurityListener</span></span><br><span class="line"><span class="comment">#JAVA_OPTS="$JAVA_OPTS -Dorg.apache.catalina.security.SecurityListener.UMASK=`umask`"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$USE_NOHUP</span>"</span> ]; then</span><br><span class="line">    <span class="keyword">if</span> <span class="variable">$hpux</span>; then</span><br><span class="line">        <span class="attribute">USE_NOHUP</span>=<span class="string">"true"</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="attribute">USE_NOHUP</span>=<span class="string">"false"</span></span><br><span class="line">    fi</span><br><span class="line">fi</span><br><span class="line">unset _NOHUP</span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$USE_NOHUP</span>"</span> = <span class="string">"true"</span> ]; then</span><br><span class="line">    <span class="attribute">_NOHUP</span>=nohup</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="comment"># ----- Execute The Requested Command -----------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Bugzilla 37848: only output this if we have a TTY</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$have_tty</span> -eq 1 ]; then</span><br><span class="line">  echo <span class="string">"Using CATALINA_BASE:   <span class="variable">$CATALINA_BASE</span>"</span></span><br><span class="line">  echo <span class="string">"Using CATALINA_HOME:   <span class="variable">$CATALINA_HOME</span>"</span></span><br><span class="line">  echo <span class="string">"Using CATALINA_TMPDIR: <span class="variable">$CATALINA_TMPDIR</span>"</span></span><br><span class="line">  <span class="keyword">if</span> [ <span class="string">"<span class="variable">$1</span>"</span> = <span class="string">"debug"</span> ] ; then</span><br><span class="line">    echo <span class="string">"Using JAVA_HOME:       <span class="variable">$JAVA_HOME</span>"</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    echo <span class="string">"Using JRE_HOME:        <span class="variable">$JRE_HOME</span>"</span></span><br><span class="line">  fi</span><br><span class="line">  echo <span class="string">"Using CLASSPATH:       <span class="variable">$CLASSPATH</span>"</span></span><br><span class="line">  <span class="keyword">if</span> [ ! -z <span class="string">"<span class="variable">$CATALINA_PID</span>"</span> ]; then</span><br><span class="line">    echo <span class="string">"Using CATALINA_PID:    <span class="variable">$CATALINA_PID</span>"</span></span><br><span class="line">  fi</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$1</span>"</span> = <span class="string">"jpda"</span> ] ; then</span><br><span class="line">  <span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$JPDA_TRANSPORT</span>"</span> ]; then</span><br><span class="line">    <span class="attribute">JPDA_TRANSPORT</span>=<span class="string">"dt_socket"</span></span><br><span class="line">  fi</span><br><span class="line">  <span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$JPDA_ADDRESS</span>"</span> ]; then</span><br><span class="line">    <span class="attribute">JPDA_ADDRESS</span>=<span class="string">"localhost:8000"</span></span><br><span class="line">  fi</span><br><span class="line">  <span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$JPDA_SUSPEND</span>"</span> ]; then</span><br><span class="line">    <span class="attribute">JPDA_SUSPEND</span>=<span class="string">"n"</span></span><br><span class="line">  fi</span><br><span class="line">  <span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$JPDA_OPTS</span>"</span> ]; then</span><br><span class="line">    <span class="attribute">JPDA_OPTS</span>=<span class="string">"-agentlib:jdwp=transport=<span class="variable">$JPDA_TRANSPORT</span>,address=<span class="variable">$JPDA_ADDRESS</span>,server=y,suspend=<span class="variable">$JPDA_SUSPEND</span>"</span></span><br><span class="line">  fi</span><br><span class="line">  <span class="attribute">CATALINA_OPTS</span>=<span class="string">"<span class="variable">$JPDA_OPTS</span> <span class="variable">$CATALINA_OPTS</span>"</span></span><br><span class="line">  shift</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$1</span>"</span> = <span class="string">"debug"</span> ] ; then</span><br><span class="line">  <span class="keyword">if</span> <span class="variable">$os400</span>; then</span><br><span class="line">    echo <span class="string">"Debug command not available on OS400"</span></span><br><span class="line">    exit 1</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    shift</span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">"<span class="variable">$1</span>"</span> = <span class="string">"-security"</span> ] ; then</span><br><span class="line">      <span class="keyword">if</span> [ <span class="variable">$have_tty</span> -eq 1 ]; then</span><br><span class="line">        echo <span class="string">"Using Security Manager"</span></span><br><span class="line">      fi</span><br><span class="line">      shift</span><br><span class="line">      exec <span class="string">"<span class="variable">$_RUNJDB</span>"</span> <span class="string">"<span class="variable">$LOGGING_CONFIG</span>"</span> <span class="variable">$LOGGING_MANAGER</span> <span class="variable">$JAVA_OPTS</span> <span class="variable">$CATALINA_OPTS</span> \</span><br><span class="line">        -Djava.endorsed.<span class="attribute">dirs</span>=<span class="string">"<span class="variable">$JAVA_ENDORSED_DIRS</span>"</span> -classpath <span class="string">"<span class="variable">$CLASSPATH</span>"</span> \</span><br><span class="line">        -sourcepath <span class="string">"<span class="variable">$CATALINA_HOME</span>"</span>/<span class="built_in">..</span>/<span class="built_in">..</span>/java \</span><br><span class="line">        -Djava.security.manager \</span><br><span class="line">        -Djava.security.<span class="attribute">policy</span>=="$CATALINA_BASE"/conf/catalina.policy \</span><br><span class="line">        -Dcatalina.<span class="attribute">base</span>=<span class="string">"<span class="variable">$CATALINA_BASE</span>"</span> \</span><br><span class="line">        -Dcatalina.<span class="attribute">home</span>=<span class="string">"<span class="variable">$CATALINA_HOME</span>"</span> \</span><br><span class="line">        -Djava.io.<span class="attribute">tmpdir</span>=<span class="string">"<span class="variable">$CATALINA_TMPDIR</span>"</span> \</span><br><span class="line">        org.apache.catalina.startup.Bootstrap <span class="string">"<span class="variable">$@</span>"</span> start</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      exec <span class="string">"<span class="variable">$_RUNJDB</span>"</span> <span class="string">"<span class="variable">$LOGGING_CONFIG</span>"</span> <span class="variable">$LOGGING_MANAGER</span> <span class="variable">$JAVA_OPTS</span> <span class="variable">$CATALINA_OPTS</span> \</span><br><span class="line">        -Djava.endorsed.<span class="attribute">dirs</span>=<span class="string">"<span class="variable">$JAVA_ENDORSED_DIRS</span>"</span> -classpath <span class="string">"<span class="variable">$CLASSPATH</span>"</span> \</span><br><span class="line">        -sourcepath <span class="string">"<span class="variable">$CATALINA_HOME</span>"</span>/<span class="built_in">..</span>/<span class="built_in">..</span>/java \</span><br><span class="line">        -Dcatalina.<span class="attribute">base</span>=<span class="string">"<span class="variable">$CATALINA_BASE</span>"</span> \</span><br><span class="line">        -Dcatalina.<span class="attribute">home</span>=<span class="string">"<span class="variable">$CATALINA_HOME</span>"</span> \</span><br><span class="line">        -Djava.io.<span class="attribute">tmpdir</span>=<span class="string">"<span class="variable">$CATALINA_TMPDIR</span>"</span> \</span><br><span class="line">        org.apache.catalina.startup.Bootstrap <span class="string">"<span class="variable">$@</span>"</span> start</span><br><span class="line">    fi</span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">elif [ <span class="string">"<span class="variable">$1</span>"</span> = <span class="string">"run"</span> ]; then</span><br><span class="line"></span><br><span class="line">  shift</span><br><span class="line">  <span class="keyword">if</span> [ <span class="string">"<span class="variable">$1</span>"</span> = <span class="string">"-security"</span> ] ; then</span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$have_tty</span> -eq 1 ]; then</span><br><span class="line">      echo <span class="string">"Using Security Manager"</span></span><br><span class="line">    fi</span><br><span class="line">    shift</span><br><span class="line">    eval exec <span class="string">"\"<span class="variable">$_RUNJAVA</span>\""</span> <span class="string">"\"<span class="variable">$LOGGING_CONFIG</span>\""</span> <span class="variable">$LOGGING_MANAGER</span> <span class="variable">$JAVA_OPTS</span> <span class="variable">$CATALINA_OPTS</span> \</span><br><span class="line">      -Djava.endorsed.<span class="attribute">dirs</span>=<span class="string">"\"<span class="variable">$JAVA_ENDORSED_DIRS</span>\""</span> -classpath <span class="string">"\"<span class="variable">$CLASSPATH</span>\""</span> \</span><br><span class="line">      -Djava.security.manager \</span><br><span class="line">      -Djava.security.<span class="attribute">policy</span>=="\"$CATALINA_BASE/conf/catalina.policy\"" \</span><br><span class="line">      -Dcatalina.<span class="attribute">base</span>=<span class="string">"\"<span class="variable">$CATALINA_BASE</span>\""</span> \</span><br><span class="line">      -Dcatalina.<span class="attribute">home</span>=<span class="string">"\"<span class="variable">$CATALINA_HOME</span>\""</span> \</span><br><span class="line">      -Djava.io.<span class="attribute">tmpdir</span>=<span class="string">"\"<span class="variable">$CATALINA_TMPDIR</span>\""</span> \</span><br><span class="line">      org.apache.catalina.startup.Bootstrap <span class="string">"<span class="variable">$@</span>"</span> start</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    eval exec <span class="string">"\"<span class="variable">$_RUNJAVA</span>\""</span> <span class="string">"\"<span class="variable">$LOGGING_CONFIG</span>\""</span> <span class="variable">$LOGGING_MANAGER</span> <span class="variable">$JAVA_OPTS</span> <span class="variable">$CATALINA_OPTS</span> \</span><br><span class="line">      -Djava.endorsed.<span class="attribute">dirs</span>=<span class="string">"\"<span class="variable">$JAVA_ENDORSED_DIRS</span>\""</span> -classpath <span class="string">"\"<span class="variable">$CLASSPATH</span>\""</span> \</span><br><span class="line">      -Dcatalina.<span class="attribute">base</span>=<span class="string">"\"<span class="variable">$CATALINA_BASE</span>\""</span> \</span><br><span class="line">      -Dcatalina.<span class="attribute">home</span>=<span class="string">"\"<span class="variable">$CATALINA_HOME</span>\""</span> \</span><br><span class="line">      -Djava.io.<span class="attribute">tmpdir</span>=<span class="string">"\"<span class="variable">$CATALINA_TMPDIR</span>\""</span> \</span><br><span class="line">      org.apache.catalina.startup.Bootstrap <span class="string">"<span class="variable">$@</span>"</span> start \</span><br><span class="line">      &gt;&gt; <span class="string">"<span class="variable">$CATALINA_OUT</span>"</span> 2&gt;&amp;1</span><br><span class="line">  fi</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">vi Dockerfile</span><br><span class="line"><span class="comment"># 基础镜像</span></span><br><span class="line"><span class="keyword">FROM</span> tomcat:<span class="number">1.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建项目目录和日志目录，这个是要在宿主机-v挂载的</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">set</span> -x \</span></span><br><span class="line"><span class="bash">    &amp;&amp;mkdir -p /Webs/logs \</span></span><br><span class="line"><span class="bash">    \</span></span><br><span class="line"><span class="bash">    &amp;&amp;rm -rf /usr/<span class="built_in">local</span>/tomcat/logs \</span></span><br><span class="line"><span class="bash">    \</span></span><br><span class="line"><span class="bash">    &amp;&amp;ln -sf /Webs/logs /usr/<span class="built_in">local</span>/tomcat/logs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将启动文件copy到容器</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> start.sh /usr/<span class="built_in">local</span>/tomcat/bin/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 给容器的启动脚本权限</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> chmod +x /usr/<span class="built_in">local</span>/tomcat/bin/start.sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 开放8080端口</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行tomcat</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"start.sh"</span>,<span class="string">"run"</span>]</span></span><br></pre></td></tr></table></figure>
<ol start="7">
<li>构建 tomcat_web 镜像</li>
</ol>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">docker</span> <span class="keyword">build </span>-t tomcat_web:<span class="built_in">v1</span> .</span><br></pre></td></tr></table></figure>
<ol start="8">
<li>创建 tomcat_web 容器的宿主目录</li>
</ol>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">cd /home/</span></span><br><span class="line"><span class="xml">mkdir test.tomcat.com &amp;&amp; cd test.tomcat.com</span></span><br><span class="line"><span class="xml">touch server.xml # 配置文件</span></span><br><span class="line"><span class="xml">mkdir logs  # 日志目录</span></span><br><span class="line"><span class="xml">mkdir wwwroot  # 项目主目录</span></span><br><span class="line"></span><br><span class="line"><span class="xml">vi server.xml</span></span><br><span class="line"></span><br><span class="line"><span class="xml"><span class="meta">&lt;?xml version='1.0' encoding='utf-8'?&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">Server</span> <span class="attr">port</span>=<span class="string">"8005"</span> <span class="attr">shutdown</span>=<span class="string">"SHUTDOWN"</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.startup.VersionLoggerListener"</span> /&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.AprLifecycleListener"</span> <span class="attr">SSLEngine</span>=<span class="string">"on"</span> /&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.JreMemoryLeakPreventionListener"</span> /&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.mbeans.GlobalResourcesLifecycleListener"</span> /&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.ThreadLocalLeakPreventionListener"</span> /&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">GlobalNamingResources</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">Resource</span> <span class="attr">name</span>=<span class="string">"UserDatabase"</span> <span class="attr">auth</span>=<span class="string">"Container"</span></span></span></span><br><span class="line"><span class="xml">              type="org.apache.catalina.UserDatabase"</span></span><br><span class="line"><span class="xml">              description="User database that can be updated and saved"</span></span><br><span class="line"><span class="xml">              factory="org.apache.catalina.users.MemoryUserDatabaseFactory"</span></span><br><span class="line"><span class="xml">              pathname="conf/tomcat-users.xml" /&gt;</span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">GlobalNamingResources</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">Service</span> <span class="attr">name</span>=<span class="string">"Catalina"</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"8080"</span> <span class="attr">protocol</span>=<span class="string">"org.apache.coyote.http11.Http11AprProtocol"</span></span></span></span><br><span class="line"><span class="xml">               connectionTimeout="20000"</span></span><br><span class="line"><span class="xml">               maxThreads="1000"</span></span><br><span class="line"><span class="xml">               minSpareThreads="100"</span></span><br><span class="line"><span class="xml">               redirectPort="8443" URIEncoding="UTF-8"/&gt;</span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"8009"</span> <span class="attr">maxThreads</span>=<span class="string">"1000"</span> <span class="attr">minSpareThreads</span>=<span class="string">"100"</span>  <span class="attr">protocol</span>=<span class="string">"AJP/1.3"</span> <span class="attr">redirectPort</span>=<span class="string">"8443"</span> /&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">Engine</span> <span class="attr">name</span>=<span class="string">"Catalina"</span> <span class="attr">defaultHost</span>=<span class="string">"localhost"</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">Realm</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.realm.LockOutRealm"</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">Realm</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.realm.UserDatabaseRealm"</span> <span class="attr">resourceName</span>=<span class="string">"UserDatabase"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">Realm</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">"localhost"</span>  <span class="attr">appBase</span>=<span class="string">"/Webs/wwwroot"</span> <span class="attr">unpackWARs</span>=<span class="string">"true"</span> <span class="attr">autoDeploy</span>=<span class="string">"true"</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">Context</span> <span class="attr">path</span>=<span class="string">""</span> <span class="attr">docBase</span>=<span class="string">"/Webs/wwwroot"</span> <span class="attr">reloadable</span>=<span class="string">"true"</span> /&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.valves.AccessLogValve"</span></span></span></span><br><span class="line"><span class="xml">        directory="logs"</span></span><br><span class="line"><span class="xml">        prefix="localhost__access_log"</span></span><br><span class="line"><span class="xml">        suffix=".txt"</span></span><br><span class="line"><span class="xml">        pattern="%</span><span class="template-variable">&#123;X-Real-IP&#125;</span><span class="xml">i %l %u %t <span class="symbol">&amp;quot;</span>%r<span class="symbol">&amp;quot;</span> %s %b" /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">Host</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">Engine</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">Service</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">Server</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> wwwroot/</span><br><span class="line">touch <span class="built_in">index</span>.html</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"hello world"</span> &gt; <span class="built_in">index</span>.html</span><br></pre></td></tr></table></figure>
<ol start="9">
<li>启动容器</li>
</ol>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="builtin-name">run</span> -tid  <span class="attribute">--restart</span>=always --name test.tomcat.com  -p 5081:8080 -v /home/test.tomcat.com/:/Webs -m 128m  <span class="attribute">--memory-swap</span>=128m  <span class="attribute">--cpu-shares</span>=256  tomcat_web:v1 start.sh  <span class="builtin-name">run</span> -config /Webs/server.xml</span><br></pre></td></tr></table></figure>
<ol start="10">
<li>其他问题 update2019-09-23</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">因openJDK不断升级，故直接按上面的脚本可能会出现构建失败的情况。</span><br><span class="line">故需按openJDK的版本进行安装</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://seven-cm.github.io/2018/07/18/vscode不格式化某个标签的配置/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="seven-cm">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="seven-cm.blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/07/18/vscode不格式化某个标签的配置/" itemprop="url">
                  vscode不格式化某个标签的配置
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-18T22:01:31+08:00">
                2018-07-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将设置放入此文件中以覆盖默认设置</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"editor.fontFamily"</span>: <span class="string">"Source Code Pro,Consolas, 'Courier New', monospace"</span>,</span><br><span class="line">    <span class="attr">"markdown.styles"</span>: [</span><br><span class="line">        <span class="string">"file:///E:/my-md.css"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"window.zoomLevel"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"files.associations"</span>: &#123;</span><br><span class="line">        <span class="attr">"*.ftl"</span>: <span class="string">"html"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"files.autoSave"</span>: <span class="string">"onWindowChange"</span>,</span><br><span class="line">    <span class="attr">"eslint.validate"</span>: [</span><br><span class="line">        <span class="string">"javascript"</span>,</span><br><span class="line">        <span class="string">"javascriptreact"</span>,</span><br><span class="line">        <span class="string">"html"</span>,</span><br><span class="line">        <span class="string">"vue"</span>,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"language"</span>: <span class="string">"vue"</span>,</span><br><span class="line">            <span class="attr">"autoFix"</span>: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"eslint.options"</span>: &#123;</span><br><span class="line">        <span class="attr">"plugins"</span>: [</span><br><span class="line">            <span class="string">"html"</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"workbench.iconTheme"</span>: <span class="string">"vscode-great-icons"</span>,</span><br><span class="line">    <span class="attr">"editor.formatOnSave"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"vetur.format.defaultFormatter.html"</span>: <span class="string">"js-beautify-html"</span>,</span><br><span class="line">    <span class="attr">"vetur.format.defaultFormatterOptions"</span>: &#123;</span><br><span class="line">        <span class="attr">"js-beautify-html"</span>: &#123;</span><br><span class="line">            <span class="comment">// 属性强制折行对齐 force-aligned //auto 自动</span></span><br><span class="line">            <span class="attr">"wrap_attributes"</span>: <span class="string">"auto"</span>,</span><br><span class="line">            <span class="comment">//不格式化的元素</span></span><br><span class="line">            <span class="attr">"unformatted"</span>: [</span><br><span class="line">                <span class="string">"span"</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"vetur.validation.template"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"terminal.integrated.shell.windows"</span>: <span class="string">"C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe"</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://seven-cm.github.io/2018/06/03/小程序授权更新/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="seven-cm">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="seven-cm.blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/06/03/小程序授权更新/" itemprop="url">
                  小程序授权更新
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-03T10:26:30+08:00">
                2018-06-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在4月份的时候，微信发出了公告：<a href="https://developers.weixin.qq.com/blogdetail?action=get_post_info&amp;lang=zh_CN&amp;token=1650183953&amp;docid=0000a26e1aca6012e896a517556c01" target="_blank" rel="noopener">小程序与小游戏获取用户信息接口调整，请开发者注意升级。</a> </p>
<p>后续浏览了一下有关获取用户信息的接口的API（wx.getUserInfo(OBJECT)），里面有提到<code>此接口有调整，使用该接口将不再出现授权弹窗</code></p>
<blockquote>
<p>当用户未授权过，调用该接口将直接报错；当用户授权过，可以使用该接口获取用户信息</p>
</blockquote>
<p>看来得引导用户主动点击授权按钮了。下面将介绍如何通过使用Promise来实现获取用户信息。</p>
<h2 id="获取用户信息流程图"><a href="#获取用户信息流程图" class="headerlink" title="获取用户信息流程图"></a>获取用户信息流程图</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">st=&gt;start: 微信授权</span><br><span class="line">e=&gt;end: 授权结束</span><br><span class="line">op1=&gt;operation: 微信登陆</span><br><span class="line">op2=&gt;operation: 显示授权按钮</span><br><span class="line">op3=&gt;operation: 显示提示授权对话框</span><br><span class="line">cond1=&gt;condition: 用户是否已经授权</span><br><span class="line">cond2=&gt;condition: 用户是否点击允许</span><br><span class="line"></span><br><span class="line">st-&gt;op1-&gt;cond1</span><br><span class="line">cond1(yes)-&gt;e</span><br><span class="line">cond1(no)-&gt;op3-&gt;op2</span><br><span class="line">op2-&gt;cond2</span><br><span class="line">cond2(no)-&gt;op2</span><br><span class="line">cond2(yes)-&gt;e</span><br></pre></td></tr></table></figure>
<h2 id="首先建立wechat-js"><a href="#首先建立wechat-js" class="headerlink" title="首先建立wechat.js"></a>首先建立wechat.js</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Wechat</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登录</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return <span class="type">&#123;Promise&#125;</span> </span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> login() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> wx.login(&#123; <span class="attr">success</span>: resolve, <span class="attr">fail</span>: reject &#125;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 获取用户是否授权</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return <span class="type">&#123;Promise&#125;</span> </span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">static</span> getSetting() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> wx.getSetting(&#123; <span class="attr">success</span>: resolve, <span class="attr">fail</span>: reject &#125;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 打开授权设置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> openSetting() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> wx.openSetting(&#123; <span class="attr">success</span>: resolve, <span class="attr">fail</span>: reject &#125;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取用户信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return <span class="type">&#123;Promise&#125;</span> </span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> getUserInfo() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> wx.getUserInfo(&#123; <span class="attr">success</span>: resolve, <span class="attr">fail</span>: reject &#125;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发起网络请求</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param <span class="type">&#123;string&#125;</span> </span>url  </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param <span class="type">&#123;object&#125;</span> </span>params </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return <span class="type">&#123;Promise&#125;</span> </span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> request(url, params, method = <span class="string">"GET"</span>, type = <span class="string">"json"</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> opts = &#123;</span><br><span class="line">                url: url,</span><br><span class="line">                data: <span class="built_in">Object</span>.assign(&#123;&#125;, params),</span><br><span class="line">                method: method,</span><br><span class="line">                header: &#123; <span class="string">'Content-Type'</span>: type &#125;,</span><br><span class="line">                success: resolve,</span><br><span class="line">                fail: reject</span><br><span class="line">            &#125;</span><br><span class="line">            wx.request(opts);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理app.js中定义的回调函数；在onload中调用</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param <span class="type">&#123;webchatApp&#125;</span> </span>app </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param <span class="type">&#123;function&#125;</span> </span>handle </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> handleCallback(app, handle) &#123;</span><br><span class="line">        <span class="keyword">if</span> (app.globalData.params) &#123;</span><br><span class="line">            handle();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            app.openIdCallback = <span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (data !== <span class="literal">null</span>) &#123;</span><br><span class="line">                    handle();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Wechat;</span><br></pre></td></tr></table></figure>
<h2 id="修改app-js"><a href="#修改app-js" class="headerlink" title="修改app.js"></a>修改app.js</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//app.js</span></span><br><span class="line"><span class="keyword">import</span> wechat <span class="keyword">from</span> <span class="string">"./utils/wechat.js"</span>;</span><br><span class="line">App(&#123;</span><br><span class="line">  onLaunch() &#123;</span><br><span class="line">    <span class="keyword">let</span> params = &#123;&#125;;</span><br><span class="line">    wechat.login().then(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> data;</span><br><span class="line">    &#125;).then(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">      params.jsCode = data;</span><br><span class="line">      <span class="keyword">return</span> wechat.getSetting()</span><br><span class="line">    &#125;).then(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">      params.auth = data.authSetting[<span class="string">'scope.userInfo'</span>] === <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">return</span> params;</span><br><span class="line">    &#125;).then(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (data.auth) &#123;</span><br><span class="line">        <span class="comment">//已经授权</span></span><br><span class="line">        <span class="comment">//获取用户信息</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'已经授权'</span>);</span><br><span class="line">        <span class="keyword">return</span> wechat.getUserInfo();</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'未授权'</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> data;</span><br><span class="line">    &#125;).then(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">//增加回调</span></span><br><span class="line">      <span class="keyword">if</span> (data.auth == <span class="literal">undefined</span>) &#123;</span><br><span class="line">        params.ui = data;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">this</span>.globalData.params = params;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.openIdCallback) &#123;</span><br><span class="line">        <span class="keyword">this</span>.openIdCallback(data);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;).catch(<span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(e);</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(e);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">  globalData: &#123;</span><br><span class="line">    params: <span class="literal">null</span>,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="修改index-wxml"><a href="#修改index-wxml" class="headerlink" title="修改index.wxml"></a>修改index.wxml</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--index.wxml--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"container"</span> <span class="attr">wx:if</span>=<span class="string">"&#123;&#123;!auth&#125;&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">wx:if</span>=<span class="string">"&#123;&#123;canIUse&#125;&#125;"</span> <span class="attr">open-type</span>=<span class="string">"getUserInfo"</span> <span class="attr">bindgetuserinfo</span>=<span class="string">"onGotUserInfo"</span>&gt;</span>微信授权<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">wx:else</span>&gt;</span>请升级微信版本<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">wx:else</span>&gt;</span></span><br><span class="line">    &#123;&#123;userInfo&#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="修改index-js"><a href="#修改index-js" class="headerlink" title="修改index.js"></a>修改index.js</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//index.js</span></span><br><span class="line"><span class="comment">//获取应用实例</span></span><br><span class="line"><span class="keyword">import</span> wechat <span class="keyword">from</span> <span class="string">"../../utils/wechat.js"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = getApp()</span><br><span class="line"></span><br><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    auth: <span class="literal">false</span>,</span><br><span class="line">    call: <span class="literal">false</span>,</span><br><span class="line">    userInfo: &#123;&#125;,</span><br><span class="line">    hasUserInfo: <span class="literal">false</span>,</span><br><span class="line">    canIUse: wx.canIUse(<span class="string">'button.open-type.getUserInfo'</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">//事件处理函数</span></span><br><span class="line"></span><br><span class="line">  onLoad: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    wechat.handleCallback(app, () =&gt; &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(app.globalData)</span><br><span class="line">      <span class="keyword">let</span> auth = app.globalData.params.auth;</span><br><span class="line">      <span class="keyword">let</span> ui = app.globalData.params.ui;</span><br><span class="line">      <span class="keyword">this</span>.setData(&#123;</span><br><span class="line">        auth: auth,</span><br><span class="line">        userInfo: ui !== <span class="literal">undefined</span> ? ui.rawData : &#123;&#125;,</span><br><span class="line">        call: <span class="literal">true</span></span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">if</span> (!auth) &#123;</span><br><span class="line">        <span class="keyword">this</span>.showAuthDialog();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">  onGotUserInfo: <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(e.detail.encryptedData);</span><br><span class="line">    <span class="built_in">console</span>.log(e.detail.iv);</span><br><span class="line">    <span class="comment">//此处如何能获取到用户信息 可以回传用户信息至服务器即可</span></span><br><span class="line">    <span class="comment">//获取到用户信息同时 this.setData(&#123;auth: true&#125;)</span></span><br><span class="line">  &#125;,</span><br><span class="line">  onShow: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.data.auth &amp;&amp; <span class="keyword">this</span>.data.call) &#123;</span><br><span class="line">      <span class="keyword">this</span>.showAuthDialog();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  showAuthDialog: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    wx.showModal(&#123;</span><br><span class="line">      title: <span class="string">'用户未授权'</span>,</span><br><span class="line">      content: <span class="string">'需要授权获取您的公开信息；请点击微信授权-允许-即可正常使用。'</span>,</span><br><span class="line">      showCancel: <span class="literal">false</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>最后有关Promse的用法，可以参考<a href="http://es6.ruanyifeng.com/#docs/promise" target="_blank" rel="noopener">Promise 对象（ECMAScript 6 入门——阮一峰）</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="seven-cm">
          <p class="site-author-name" itemprop="name">seven-cm</p>
           
              <p class="site-description motion-element" itemprop="description">少敲代码，多陪家人</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">80</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">100</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/seven-cm" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">seven-cm</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  








  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  





  





  







  





  

  

  

  

  

</body>
</html>
